<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin İşlemleri</title>
  <style>
    :root { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background:#f4f6fb; color:#111; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
    h1 { font-size: 44px; margin: 8px 0 16px; }
    .card { background:#fff; border-radius: 18px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.06); margin: 12px 0; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input { width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid #d7dbe6; font-size: 16px; }
    label { font-weight: 700; display:block; margin: 10px 0 6px; }
    button { border:0; padding: 12px 14px; border-radius: 12px; font-weight: 800; cursor:pointer; }
    .btn { background:#1e66ff; color:#fff; }
    .btn2 { background:#0e1626; color:#fff; }
    .pill { display:inline-block; padding:8px 12px; border-radius: 999px; font-weight:800; }
    .ok { background:#dff7e8; color:#0b6b2f; }
    .bad { background:#ffe1e1; color:#7f1d1d; }
    .muted { color:#5a6477; }
    .tabs { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .tab { padding:10px 12px; border-radius: 12px; border:1px solid #e5e9f3; background:#fff; cursor:pointer; font-weight:800; }
    .tab.active { background:#0e1626; color:#fff; border-color:#0e1626; }
    .hidden { display:none !important; }

    /* list (tek satır) */
    .list { display:flex; flex-direction:column; gap:10px; margin-top:12px; }
    .line {
      display:grid;
      grid-template-columns: 1.2fr 1.2fr 1.2fr 0.9fr 0.9fr;
      gap:10px;
      align-items:center;
      border:1px solid #e5e9f3;
      border-radius: 14px;
      padding: 12px;
      background:#fff;
    }
    .cell b { display:block; }
    .small { font-size:13px; color:#556; word-break: break-word; }
    .chip { display:inline-block; padding:6px 10px; border-radius:999px; background:#f0f3fa; font-weight:800; }
    .thumbs { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .thumb {
      width:54px; height:54px; border-radius: 12px;
      object-fit:cover; border:1px solid #e5e9f3; background:#fafafa;
    }
    .actions { display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }

    pre { white-space: pre-wrap; word-break: break-word; background:#0e1626; color:#eaf0ff; padding:12px; border-radius: 14px; margin:0; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Admin İşlemleri</h1>

    <div class="card">
      <div id="adminBadge" class="pill bad">Admin: HAYIR</div>
      <p class="muted" style="margin-top:10px">
        Not: Admin yetkisi için Firestore’da <b>admins/{UID}</b> dokümanı olmalı.
      </p>

      <!-- LOGIN FORM (giriş varsa gizlenecek) -->
      <div id="loginBox">
        <label>Email</label>
        <input id="email" type="email" placeholder="admin@email.com" autocomplete="email" />
        <label>Şifre</label>
        <div class="row">
          <input id="pass" type="password" placeholder="••••••••" autocomplete="current-password" style="flex:1" />
          <button id="btnLogin" class="btn" style="min-width:120px">Giriş</button>
        </div>
      </div>

      <!-- SESSION BOX (giriş yoksa gizlenecek) -->
      <div id="sessionBox" class="hidden" style="margin-top:10px">
        <div><b>Giriş yapan:</b> <span id="who">-</span></div>
        <div><b>UID:</b> <span id="uid">-</span></div>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="btnLogout" class="btn2">Çıkış</button>
      </div>
    </div>

    <div class="card">
      <div class="tabs">
        <button id="tabPending" class="tab active">Bekleyen Fallar</button>
        <button id="tabAll" class="tab">Son 50 Upload (tümü)</button>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnLoadPending" class="btn2">Bekleyenleri Yenile</button>
        <button id="btnLoadAll" class="btn2">Son 50’yi Yenile</button>
      </div>

      <div class="muted" style="margin-top:10px" id="statusLine">Durum: Oturum kapalı.</div>

      <div class="list" id="list"></div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px">Debug</h2>
      <pre id="debug">Hazır.</pre>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      query,
      where,
      orderBy,
      limit,
      getDocs,
      addDoc,
      updateDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBDTN_8sf9P7uwtnRqBTmlszcztb36g-XA",
      authDomain: "falhane-e3057.firebaseapp.com",
      projectId: "falhane-e3057",
      storageBucket: "falhane-e3057.firebasestorage.app",
      messagingSenderId: "117754512778",
      appId: "1:117754512778:web:52aee440472568bc6cb473",
      measurementId: "G-94TZ14VWPX"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id) => document.getElementById(id);
    const log = (msg) => { $("debug").textContent = (msg + "\n\n" + $("debug").textContent).slice(0, 7000); };

    let currentUser = null;
    let isAdmin = false;
    let activeTab = "pending"; // "pending" | "all"

    function setAdminBadge(val) {
      isAdmin = val;
      $("adminBadge").textContent = val ? "Admin: EVET" : "Admin: HAYIR";
      $("adminBadge").className = "pill " + (val ? "ok" : "bad");
    }

    function showLoggedInUI(user) {
      // 1) giriş yaptıktan sonra login form görünmesin
      if (user) {
        $("loginBox").classList.add("hidden");
        $("sessionBox").classList.remove("hidden");
        $("who").textContent = user.email || "(email yok)";
        $("uid").textContent = user.uid;
      } else {
        $("loginBox").classList.remove("hidden");
        $("sessionBox").classList.add("hidden");
        $("who").textContent = "-";
        $("uid").textContent = "-";
      }
    }

    async function checkAdmin(uid) {
      const ref = doc(db, "admins", uid);
      const snap = await getDoc(ref);
      return snap.exists();
    }

    function tsToText(ts) {
      try {
        if (!ts) return "-";
        if (ts.toDate) return ts.toDate().toLocaleString();
        // bazen plain date/string gelebilir
        return String(ts);
      } catch { return "-"; }
    }

    function pickPhotoUrls(data) {
      // Olası alan adları (senin yapına göre):
      const candidates = [
        data.photo1Url, data.photo2Url,
        data.photo1, data.photo2,
        data.image1Url, data.image2Url,
        data.img1, data.img2
      ].filter(Boolean);

      // photos array ise
      if (Array.isArray(data.photos)) {
        for (const p of data.photos) {
          if (typeof p === "string") candidates.push(p);
          else if (p?.url) candidates.push(p.url);
        }
      }

      const u1 = candidates[0] || "";
      const u2 = candidates[1] || "";
      return [u1, u2];
    }

    async function copyLine(item) {
      const [u1, u2] = pickPhotoUrls(item);
      const text =
`İsim: ${item.name || "-"}
Yaş: ${item.age ?? "-"}
Burç: ${item.zodiac || "-"}
Gönderim: ${item.createdAtText || "-"}
UID: ${item.userId || "-"}
Foto1: ${u1 || "-"}
Foto2: ${u2 || "-"}`;

      try {
        await navigator.clipboard.writeText(text);
        log("KOPYA OK: " + item.id);
      } catch (e) {
        log("KOPYA HATA: " + (e?.message || e));
        // iOS bazen clipboard izin sorunu çıkarır; fallback:
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
      }
    }

    function renderList(items) {
      const wrap = $("list");
      wrap.innerHTML = "";

      if (!items.length) {
        wrap.innerHTML = `<div class="muted">Kayıt yok.</div>`;
        return;
      }

      for (const it of items) {
        const [u1, u2] = pickPhotoUrls(it);

        const div = document.createElement("div");
        div.className = "line";

        div.innerHTML = `
          <div class="cell">
            <b>${it.name || "(isim yok)"}</b>
            <div class="small">Yaş: ${it.age ?? "-"} • Burç: ${it.zodiac || "-"}</div>
          </div>

          <div class="cell">
            <span class="chip">Gönderim</span>
            <div class="small">${it.createdAtText || "-"}</div>
          </div>

          <div class="cell">
            <span class="chip">UserId</span>
            <div class="small">${it.userId || "-"}</div>
          </div>

          <div class="cell">
            <div class="thumbs">
              ${u1 ? `<a href="${u1}" target="_blank" rel="noopener"><img class="thumb" src="${u1}" alt="foto1"></a>` : `<div class="small">Foto1 yok</div>`}
              ${u2 ? `<a href="${u2}" target="_blank" rel="noopener"><img class="thumb" src="${u2}" alt="foto2"></a>` : ``}
            </div>
            <div class="small">${(u1 || u2) ? "Resme tıklayınca açılır." : ""}</div>
          </div>

          <div class="cell">
            <div class="actions">
              <button class="btn2" data-copy="${it.id}">Resimleri Kopyala</button>
              ${activeTab === "pending" ? `<button class="btn" data-approve="${it.id}">Onayla</button>` : ``}
              ${activeTab === "pending" ? `<button class="btn2" data-reject="${it.id}">Reddet</button>` : ``}
            </div>
          </div>
        `;

        wrap.appendChild(div);
      }

      wrap.querySelectorAll("[data-copy]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-copy");
          const item = items.find(x => x.id === id);
          if (item) copyLine(item);
        });
      });

      wrap.querySelectorAll("[data-approve]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-approve");
          await approveUpload(id);
        });
      });

      wrap.querySelectorAll("[data-reject]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-reject");
          await rejectUpload(id);
        });
      });
    }

    async function loadPending() {
      if (!currentUser) { $("statusLine").textContent = "Durum: Oturum kapalı."; return; }
      if (!isAdmin) { $("statusLine").textContent = "Durum: Admin değilsin."; return; }

      activeTab = "pending";
      $("tabPending").classList.add("active");
      $("tabAll").classList.remove("active");

      $("statusLine").textContent = "Durum: Bekleyen fallar yükleniyor...";
      const q = query(
        collection(db, "uploads"),
        where("status", "==", "pending"),
        orderBy("createdAt", "desc"),
        limit(50)
      );
      const snap = await getDocs(q);

      const items = snap.docs.map(d => {
        const data = d.data() || {};
        return {
          id: d.id,
          ...data,
          createdAtText: tsToText(data.createdAt)
        };
      });

      $("statusLine").textContent = `Durum: ${items.length} bekleyen fal.`;
      renderList(items);
    }

    async function loadAllLast50() {
      if (!currentUser) { $("statusLine").textContent = "Durum: Oturum kapalı."; return; }
      if (!isAdmin) { $("statusLine").textContent = "Durum: Admin değilsin."; return; }

      activeTab = "all";
      $("tabAll").classList.add("active");
      $("tabPending").classList.remove("active");

      $("statusLine").textContent = "Durum: Son 50 upload yükleniyor...";
      const q = query(collection(db, "uploads"), orderBy("createdAt", "desc"), limit(50));
      const snap = await getDocs(q);

      const items = snap.docs.map(d => {
        const data = d.data() || {};
        return {
          id: d.id,
          ...data,
          createdAtText: tsToText(data.createdAt)
        };
      });

      $("statusLine").textContent = `Durum: ${items.length} kayıt geldi.`;
      renderList(items);
    }

    async function approveUpload(uploadId) {
      if (!currentUser || !isAdmin) return;

      const uploadRef = doc(db, "uploads", uploadId);
      const upSnap = await getDoc(uploadRef);
      if (!upSnap.exists()) { log("APPROVE: upload bulunamadı: " + uploadId); return; }
      const data = upSnap.data() || {};

      await addDoc(collection(db, "readings"), {
        ...data,
        status: "approved",
        approvedBy: currentUser.uid,
        approvedAt: serverTimestamp()
      });

      await updateDoc(uploadRef, {
        status: "approved",
        approvedBy: currentUser.uid,
        approvedAt: serverTimestamp()
      });

      log("APPROVE OK: " + uploadId);
      await loadPending();
    }

    async function rejectUpload(uploadId) {
      if (!currentUser || !isAdmin) return;

      const uploadRef = doc(db, "uploads", uploadId);
      await updateDoc(uploadRef, {
        status: "rejected",
        reviewedBy: currentUser.uid,
        reviewedAt: serverTimestamp()
      });

      log("REJECT OK: " + uploadId);
      await loadPending();
    }

    // UI events
    $("btnLogin").addEventListener("click", async () => {
      const email = $("email").value.trim();
      const pass = $("pass").value;
      try {
        log("LOGIN: email/password deniyor...");
        await signInWithEmailAndPassword(auth, email, pass);
        log("LOGIN OK");
      } catch (e) {
        log("LOGIN ERROR: " + (e?.message || e));
      }
    });

    $("btnLogout").addEventListener("click", async () => {
      try {
        await signOut(auth);
        log("LOGOUT OK");
      } catch (e) {
        log("LOGOUT ERROR: " + (e?.message || e));
      }
    });

    $("btnLoadPending").addEventListener("click", loadPending);
    $("btnLoadAll").addEventListener("click", loadAllLast50);

    $("tabPending").addEventListener("click", loadPending);
    $("tabAll").addEventListener("click", loadAllLast50);

    // Auth listener
    onAuthStateChanged(auth, async (user) => {
      currentUser = user || null;
      showLoggedInUI(user);

      if (!user) {
        setAdminBadge(false);
        $("statusLine").textContent = "Durum: Oturum kapalı.";
        $("list").innerHTML = "";
        return;
      }

      try {
        const ok = await checkAdmin(user.uid);
        setAdminBadge(ok);
        $("statusLine").textContent = ok
          ? "Durum: Giriş OK. Admin ise listeleyebilirsin."
          : "Durum: Giriş OK ama admin değilsin. Firestore admins/{UID} lazım.";

        log(`BOOT:\nurl=${location.href}\nAUTH STATE: signed in\nADMIN CHECK: ${ok ? "OK" : "NO"}`);

        // girişten sonra otomatik bekleyenleri yükle
        if (ok) await loadPending();
      } catch (e) {
        setAdminBadge(false);
        $("statusLine").textContent = "Durum: Admin kontrol hatası.";
        log("ADMIN CHECK ERROR: " + (e?.message || e));
      }
    });
  </script>
</body>
</html>