<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Falhane Admin Paneli</title>
  <style>
    :root { --bg:#f4f6fb; --card:#fff; --text:#0b1220; --muted:#5b667a; --pri:#2563eb; --dark:#0b1220; --ok:#16a34a; --bad:#dc2626; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);}
    .wrap{max-width:980px;margin:0 auto;padding:22px;}
    h1{font-size:44px;line-height:1.02;margin:8px 0 18px;font-weight:800;}
    .grid{display:grid;gap:16px;}
    .card{background:var(--card);border-radius:18px;padding:16px 16px;box-shadow:0 12px 30px rgba(10,20,40,.08);}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{border:0;border-radius:12px;padding:12px 14px;font-weight:700;cursor:pointer}
    .btn.pri{background:var(--pri);color:#fff}
    .btn.dark{background:var(--dark);color:#fff}
    .btn.ok{background:var(--ok);color:#fff}
    .btn.bad{background:var(--bad);color:#fff}
    .btn.ghost{background:#eef2ff;color:#1e40af}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px}
    .pill.ok{background:#dcfce7;color:#166534}
    .pill.pending{background:#fff7ed;color:#9a3412}
    .pill.bad{background:#fee2e2;color:#991b1b}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .debugbox{background:#0b1220;color:#dbeafe;border-radius:14px;padding:14px;white-space:pre-wrap;overflow:auto}
    .list{display:grid;gap:12px}
    .item{border:1px solid rgba(10,20,40,.10);border-radius:14px;padding:12px}
    .item h3{margin:0 0 6px;font-size:18px}
    .meta{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:13px}
    .photos{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:10px}
    .ph{border-radius:12px;border:1px solid rgba(10,20,40,.12);overflow:hidden;background:#fff}
    .ph img{display:block;width:100%;height:240px;object-fit:cover}
    .small{font-size:12px}
    .hr{height:1px;background:rgba(10,20,40,.10);margin:10px 0}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Admin İşlemleri</h1>

    <div class="grid">
      <div class="card">
        <div class="row">
          <button id="btnLogin" class="btn pri">Google ile giriş</button>
          <button id="btnLogout" class="btn dark">Çıkış</button>
          <span id="pillAdmin" class="pill pending">Admin: kontrol ediliyor…</span>
          <span class="right muted small">Not: Admin yetkisi için Firestore’da <b>admins/{UID}</b> dokümanı olmalı.</span>
        </div>

        <div class="hr"></div>

        <div class="row">
          <div>
            <div class="muted small">Giriş yapan:</div>
            <div id="who" class="mono">-</div>
          </div>
          <div>
            <div class="muted small">UID:</div>
            <div id="uid" class="mono">-</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <button id="btnLoadPending" class="btn dark">Pending Uploads Yükle</button>
          <button id="btnLoadLast" class="btn dark">Son 50 Upload (tümü) yükle</button>
          <span id="status" class="muted">Durum: -</span>
        </div>
        <div class="hr"></div>
        <div id="list" class="list"></div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 10px">Debug</h2>
        <div id="debug" class="debugbox">Hazır.</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithRedirect,
      getRedirectResult,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      query,
      where,
      orderBy,
      limit,
      getDocs,
      serverTimestamp,
      writeBatch,
      addDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ==== SENİN CONFIG (DEĞİŞTİRME) ====
    const firebaseConfig = {
      apiKey: "AIzaSyBDTN_8sf9P7uwtnRqBTmlszcztb36g-XA",
      authDomain: "falhane-e3057.firebaseapp.com",
      projectId: "falhane-e3057",
      storageBucket: "falhane-e3057.firebasestorage.app",
      messagingSenderId: "117754512778",
      appId: "1:117754512778:web:52aee440472568bc6cb473",
      measurementId: "G-94TZ14VWPX"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // UI
    const $ = (id) => document.getElementById(id);
    const dbg = (s) => { $("debug").textContent = String(s); };
    const dbgAdd = (s) => { $("debug").textContent += "\\n" + String(s); };

    let currentUser = null;
    let isAdmin = false;

    function setAdminPill(state) {
      const pill = $("pillAdmin");
      pill.classList.remove("ok","pending","bad");
      if (state === true) { pill.classList.add("ok"); pill.textContent = "Admin: EVET"; }
      else if (state === false) { pill.classList.add("bad"); pill.textContent = "Admin: HAYIR"; }
      else { pill.classList.add("pending"); pill.textContent = "Admin: kontrol ediliyor…"; }
    }

    function setStatus(t) { $("status").textContent = "Durum: " + t; }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    function statusPill(status){
      if (status === "approved") return `<span class="pill ok">approved</span>`;
      if (status === "rejected") return `<span class="pill bad">rejected</span>`;
      return `<span class="pill pending">pending</span>`;
    }

    async function checkAdmin(uid){
      // Admin kontrol: admins/{uid} var mı?
      try{
        const ref = doc(db, "admins", uid);
        const snap = await getDoc(ref);
        isAdmin = snap.exists();
        setAdminPill(isAdmin);
        dbgAdd("ADMIN CHECK: " + (isAdmin ? "OK" : "NO"));
        return isAdmin;
      }catch(e){
        isAdmin = false;
        setAdminPill(false);
        dbgAdd("ADMIN CHECK ERROR: " + e.message);
        return false;
      }
    }

    function renderList(docs){
      const root = $("list");
      root.innerHTML = "";
      if (!docs.length){
        root.innerHTML = `<div class="muted">Kayıt yok.</div>`;
        return;
      }

      for (const d of docs){
        const data = d.data();
        const id = d.id;

        const name = data.name ?? data.ad ?? "";
        const age  = data.age ?? data.yas ?? "";
        const zodiac = data.zodiac ?? data.burc ?? "";
        const userId = data.userId ?? "";
        const createdAt = data.createdAt?.toDate ? data.createdAt.toDate().toISOString() : (data.createdAt ?? "");
        const status = data.status ?? "pending";

        // Foto alanları (hangi isimle kaydediyorsan yakalayalım)
        const photo1 = data.photo1Url || data.photo1 || data.image1Url || data.image1 || data.img1 || "";
        const photo2 = data.photo2Url || data.photo2 || data.image2Url || data.image2 || data.img2 || "";

        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="row">
            <h3 class="mono" style="margin:0">${escapeHtml(id)}</h3>
            ${statusPill(status)}
            <button class="btn ghost right" data-json="${escapeHtml(id)}">JSON</button>
          </div>
          <div class="meta">
            <div><b>userId:</b> <span class="mono">${escapeHtml(userId)}</span></div>
            <div><b>createdAt:</b> <span class="mono">${escapeHtml(createdAt)}</span></div>
            ${name ? `<div><b>ad:</b> ${escapeHtml(name)}</div>` : ""}
            ${age ? `<div><b>yaş:</b> ${escapeHtml(age)}</div>` : ""}
            ${zodiac ? `<div><b>burç:</b> ${escapeHtml(zodiac)}</div>` : ""}
          </div>

          <div class="photos">
            <div class="ph">${photo1 ? `<img src="${escapeHtml(photo1)}" alt="foto1">` : `<div class="muted small" style="padding:12px">Foto1 yok</div>`}</div>
            <div class="ph">${photo2 ? `<img src="${escapeHtml(photo2)}" alt="foto2">` : `<div class="muted small" style="padding:12px">Foto2 yok</div>`}</div>
          </div>

          <div class="row" style="margin-top:10px">
            <button class="btn ok" data-approve="${escapeHtml(id)}">Onayla → readings</button>
            <button class="btn bad" data-reject="${escapeHtml(id)}">Reddet</button>
          </div>

          <div id="json-${escapeHtml(id)}" class="debugbox" style="display:none;margin-top:10px"></div>
        `;
        root.appendChild(div);

        // JSON toggle
        div.querySelector(`[data-json="${CSS.escape(id)}"]`).addEventListener("click", () => {
          const box = div.querySelector(`#json-${CSS.escape(id)}`);
          const isOpen = box.style.display !== "none";
          box.style.display = isOpen ? "none" : "block";
          if (!isOpen) box.textContent = JSON.stringify(data, null, 2);
        });

        // Approve
        div.querySelector(`[data-approve="${CSS.escape(id)}"]`).addEventListener("click", async () => {
          await approveUpload(id);
        });

        // Reject
        div.querySelector(`[data-reject="${CSS.escape(id)}"]`).addEventListener("click", async () => {
          await rejectUpload(id);
        });
      }
    }

    async function loadPending(){
      if (!currentUser) { setStatus("Önce giriş yap"); return; }
      if (!isAdmin) { setStatus("Admin değilsin"); return; }

      setStatus("pending yükleniyor…");
      dbg("LOAD: pending sorgusu…");

      try{
        // where(status == pending) + orderBy(createdAt desc) genelde index ister.
        // Hata verirse Firebase zaten link verir.
        const q = query(
          collection(db, "uploads"),
          where("status", "==", "pending"),
          orderBy("createdAt", "desc"),
          limit(50)
        );
        const snap = await getDocs(q);
        const docs = snap.docs;

        renderList(docs);
        setStatus(`pending: ${docs.length} (max 50)`);
        dbgAdd("LOAD pending OK: " + docs.length);
      }catch(e){
        setStatus("HATA: " + e.message);
        dbgAdd("LOAD pending ERROR: " + e.message);
        // Index linkini kullanıcı görsün diye debug’a bas
        if (String(e.message).includes("index")) {
          dbgAdd("\\nBU HATA INDEX İSTER. Hata mesajındaki linkten create index yap.");
        }
      }
    }

    async function loadLast50(){
      if (!currentUser) { setStatus("Önce giriş yap"); return; }
      if (!isAdmin) { setStatus("Admin değilsin"); return; }

      setStatus("son 50 yükleniyor…");
      dbg("LOAD: son 50 upload…");

      try{
        const q = query(
          collection(db, "uploads"),
          orderBy("createdAt", "desc"),
          limit(50)
        );
        const snap = await getDocs(q);
        const docs = snap.docs;

        renderList(docs);
        setStatus(`toplam: ${docs.length} (son 50)`);
        dbgAdd("LOAD last50 OK: " + docs.length);
      }catch(e){
        setStatus("HATA: " + e.message);
        dbgAdd("LOAD last50 ERROR: " + e.message);
      }
    }

    async function approveUpload(uploadId){
      if (!currentUser) { alert("Önce giriş yap"); return; }
      if (!isAdmin) { alert("Admin değilsin"); return; }

      const ok = confirm("Onaylıyorsun. readings'e taşınacak. Emin misin?");
      if (!ok) return;

      try{
        setStatus("Onaylanıyor…");
        dbg("APPROVE: " + uploadId);

        const uploadRef = doc(db, "uploads", uploadId);
        const snap = await getDoc(uploadRef);
        if (!snap.exists()) { alert("Upload bulunamadı"); return; }

        const u = snap.data();

        // readings dokümanına yazılacak alanlar (uploads'taki veriyi baz alıyoruz)
        const readingPayload = {
          ...u,
          sourceUploadId: uploadId,
          status: "approved",
          approvedAt: serverTimestamp(),
          approvedBy: currentUser.uid
        };

        // Bazı alanları temize çek (istersen)
        delete readingPayload.rejectedAt;
        delete readingPayload.rejectedBy;

        const batch = writeBatch(db);

        // 1) readings'e yeni doc
        const readingsCol = collection(db, "readings");
        const newReadingRef = doc(readingsCol); // ID bizden
        batch.set(newReadingRef, readingPayload);

        // 2) upload status update
        batch.update(uploadRef, {
          status: "approved",
          approvedAt: serverTimestamp(),
          approvedBy: currentUser.uid
        });

        await batch.commit();

        dbgAdd("APPROVE OK. readingId=" + newReadingRef.id);
        setStatus("Onaylandı ✅ (readings yazıldı)");

        // Listeyi yenile
        await loadPending();
      }catch(e){
        dbgAdd("APPROVE ERROR: " + e.message);
        setStatus("HATA: " + e.message);
        alert("Hata: " + e.message);
      }
    }

    async function rejectUpload(uploadId){
      if (!currentUser) { alert("Önce giriş yap"); return; }
      if (!isAdmin) { alert("Admin değilsin"); return; }

      const ok = confirm("Reddedeceksin. Emin misin?");
      if (!ok) return;

      try{
        setStatus("Reddediliyor…");
        dbg("REJECT: " + uploadId);

        const uploadRef = doc(db, "uploads", uploadId);

        const batch = writeBatch(db);
        batch.update(uploadRef, {
          status: "rejected",
          rejectedAt: serverTimestamp(),
          rejectedBy: currentUser.uid
        });
        await batch.commit();

        dbgAdd("REJECT OK.");
        setStatus("Reddedildi ❌");

        await loadPending();
      }catch(e){
        dbgAdd("REJECT ERROR: " + e.message);
        setStatus("HATA: " + e.message);
        alert("Hata: " + e.message);
      }
    }

    // ==== EVENTS ====
    $("btnLogin").addEventListener("click", async () => {
      dbg("LOGIN: signInWithRedirect…");
      try{
        await signInWithRedirect(auth, provider);
      }catch(e){
        dbgAdd("LOGIN ERROR: " + e.message);
        alert("Login hata: " + e.message);
      }
    });

    $("btnLogout").addEventListener("click", async () => {
      try{
        await signOut(auth);
        dbg("Çıkış yapıldı.");
      }catch(e){
        dbgAdd("LOGOUT ERROR: " + e.message);
      }
    });

    $("btnLoadPending").addEventListener("click", loadPending);
    $("btnLoadLast").addEventListener("click", loadLast50);

    // ==== BOOT ====
    (async () => {
      dbg("BOOT: url=" + location.href);
      setAdminPill(null);

      // Redirect sonucu (varsa) yakala
      try{
        dbgAdd("REDIRECT: getRedirectResult() çağrılıyor…");
        const res = await getRedirectResult(auth);
        if (res && res.user){
          dbgAdd("REDIRECT: user geldi: " + (res.user.email || res.user.uid));
        } else {
          dbgAdd("REDIRECT: sonuç yok (normal).");
        }
      }catch(e){
        dbgAdd("REDIRECT ERROR: " + e.message);
      }

      onAuthStateChanged(auth, async (u) => {
        currentUser = u || null;

        if (u){
          $("who").textContent = u.email || "-";
          $("uid").textContent = u.uid;
          dbgAdd("AUTH STATE: signed in");
          await checkAdmin(u.uid);
          setStatus("Giriş OK. Admin ise listeleyebilirsin.");
        }else{
          $("who").textContent = "-";
          $("uid").textContent = "-";
          isAdmin = false;
          setAdminPill(false);
          dbgAdd("AUTH STATE: null");
          setStatus("Oturum kapalı.");
          $("list").innerHTML = "";
        }
      });
    })();
  </script>
</body>
</html>