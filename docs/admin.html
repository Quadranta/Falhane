<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Falhane - Admin</title>
  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --text:#0f172a; --muted:#64748b;
      --ok:#16a34a; --bad:#ef4444; --primary:#2563eb; --dark:#111827;
      --border:#e5e7eb;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);}
    .wrap{max-width:980px;margin:0 auto;padding:18px;}
    h1{font-size:42px;letter-spacing:-.02em;margin:10px 0 16px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 6px 24px rgba(15,23,42,.06);}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:#f8fafc;color:var(--muted);font-weight:600}
    .pill.ok{background:#ecfdf5;color:#065f46;border-color:#bbf7d0}
    .pill.bad{background:#fef2f2;color:#991b1b;border-color:#fecaca}
    button{border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    button.primary{background:var(--primary);color:#fff}
    button.dark{background:var(--dark);color:#fff}
    button.ok{background:var(--ok);color:#fff}
    button.bad{background:var(--bad);color:#fff}
    button.ghost{background:#eef2ff;color:#1e40af}
    button:disabled{opacity:.5;cursor:not-allowed}
    .muted{color:var(--muted)}
    .small{font-size:13px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab{background:#fff;border:1px solid var(--border);padding:10px 14px;border-radius:999px;font-weight:800;color:#0f172a}
    .tab.active{background:#111827;color:#fff;border-color:#111827}
    .req{display:flex;gap:12px;align-items:flex-start}
    .reqCard{background:#fff;border:1px solid var(--border);border-radius:16px;padding:14px}
    .reqHead{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .name{font-size:28px;margin:0}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 10px}
    .chip{background:#eef2ff;color:#1e40af;border:1px solid #c7d2fe;padding:6px 10px;border-radius:999px;font-weight:800}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:6px 10px;margin:8px 0}
    .kv div:nth-child(odd){color:var(--muted);font-weight:700}
    .photos{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .thumb{width:92px;height:92px;border-radius:14px;border:1px solid var(--border);object-fit:cover;background:#f1f5f9}
    textarea{width:100%;min-height:110px;resize:vertical;border:1px solid var(--border);border-radius:12px;padding:10px;font-size:15px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .hr{height:1px;background:var(--border);margin:12px 0}
    pre{white-space:pre-wrap;background:#0b1220;color:#dbeafe;padding:12px;border-radius:14px;overflow:auto}
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Admin İşlemleri</h1>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <span id="adminBadge" class="pill bad">Admin: HAYIR</span>
          <span class="pill">Giriş yapan: <span id="who">-</span></span>
          <span class="pill">UID: <span id="uid">-</span></span>
        </div>
        <div class="row">
          <button id="btnGoogleLogin" class="primary">Google ile giriş</button>
          <button id="btnLogout" class="dark" style="display:none">Çıkış</button>
        </div>
      </div>
      <div class="hr"></div>
      <div class="muted">
        Not: Admin yetkisi için Firestore’da <b>admins/{UID}</b> dokümanı olmalı.
      </div>
      <div class="small muted" id="status">Durum: Oturum kapalı.</div>
    </div>

    <div class="card">
      <div class="tabs">
        <button id="tabPending" class="tab active">Bekleyen Fallar</button>
        <button id="tabLast" class="tab">Son 50 (tümü)</button>
        <button id="btnRefresh" class="tab" style="background:#2563eb;color:#fff;border-color:#2563eb">Yenile</button>
      </div>
      <div class="small muted" id="countInfo">Durum: -</div>
      <div id="list" class="grid" style="margin-top:12px"></div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px">Debug</h2>
      <pre id="debug">Hazır.</pre>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      GoogleAuthProvider,
      signInWithRedirect,
      getRedirectResult,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      orderBy,
      limit,
      getDocs,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ✅ SENİN CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyBDTN_8sf9P7uwtnRqBTmlszcztb36g-XA",
      authDomain: "falhane-e3057.firebaseapp.com",
      projectId: "falhane-e3057",
      storageBucket: "falhane-e3057.firebasestorage.app",
      messagingSenderId: "117754512778",
      appId: "1:117754512778:web:52aee440472568bc6cb473",
      measurementId: "G-94TZ14VWPX"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: "select_account" });

    // UI
    const btnGoogleLogin = document.getElementById("btnGoogleLogin");
    const btnLogout = document.getElementById("btnLogout");
    const adminBadge = document.getElementById("adminBadge");
    const who = document.getElementById("who");
    const uidEl = document.getElementById("uid");
    const statusEl = document.getElementById("status");
    const debugEl = document.getElementById("debug");
    const listEl = document.getElementById("list");
    const countInfo = document.getElementById("countInfo");
    const tabPending = document.getElementById("tabPending");
    const tabLast = document.getElementById("tabLast");
    const btnRefresh = document.getElementById("btnRefresh");

    let currentUser = null;
    let isAdmin = false;
    let viewMode = "pending"; // pending | last

    function log(msg){
      console.log(msg);
      debugEl.textContent = (debugEl.textContent + "\n" + msg).slice(-6000);
    }

    function fmtDate(d){
      if(!d) return "-";
      try{
        const dt = d instanceof Date ? d : d.toDate();
        const pad = (n)=> String(n).padStart(2,"0");
        return `${pad(dt.getDate())}-${pad(dt.getMonth()+1)}-${dt.getFullYear()} ${pad(dt.getHours())}:${pad(dt.getMinutes())}:${pad(dt.getSeconds())}`;
      }catch{
        return "-";
      }
    }

    async function checkAdmin(uid){
      const ref = doc(db, "admins", uid);
      const snap = await getDoc(ref);
      return snap.exists();
    }

    function setAdminBadge(ok){
      adminBadge.className = "pill " + (ok ? "ok" : "bad");
      adminBadge.textContent = ok ? "Admin: EVET" : "Admin: HAYIR";
    }

    async function refreshAuthUI(user){
      if(!user){
        currentUser = null;
        isAdmin = false;
        who.textContent = "-";
        uidEl.textContent = "-";
        setAdminBadge(false);
        statusEl.textContent = "Durum: Oturum kapalı.";
        btnGoogleLogin.style.display = "";
        btnLogout.style.display = "none";
        listEl.innerHTML = "";
        countInfo.textContent = "Durum: Oturum kapalı.";
        return;
      }

      currentUser = user;
      who.textContent = user.email || "-";
      uidEl.textContent = user.uid || "-";
      btnGoogleLogin.style.display = "none";
      btnLogout.style.display = "";
      statusEl.textContent = "Durum: Giriş OK. Admin isen listeleyebilirsin.";

      try{
        isAdmin = await checkAdmin(user.uid);
      }catch(e){
        isAdmin = false;
        log("ADMIN CHECK ERROR: " + (e?.message || e));
      }
      setAdminBadge(isAdmin);

      if(isAdmin){
        await loadList();
      }else{
        listEl.innerHTML = `<div class="reqCard"><b>Bu hesap admin değil.</b><div class="muted small">Firestore’da admins/${user.uid} dokümanı yok.</div></div>`;
        countInfo.textContent = "Durum: Admin değilsin.";
      }
    }

    async function loadList(){
      if(!currentUser) { countInfo.textContent = "Durum: Oturum kapalı."; return; }
      if(!isAdmin) { countInfo.textContent = "Durum: Admin değilsin."; return; }

      listEl.innerHTML = "";
      countInfo.textContent = "Yükleniyor...";

      try{
        let q;
        if(viewMode === "pending"){
          q = query(
            collection(db, "uploads"),
            where("status","==","pending"),
            orderBy("createdAt","desc"),
            limit(50)
          );
        }else{
          q = query(
            collection(db, "uploads"),
            orderBy("createdAt","desc"),
            limit(50)
          );
        }

        const snap = await getDocs(q);
        const items = [];
        snap.forEach(docSnap => {
          items.push({ id: docSnap.id, ...docSnap.data() });
        });

        countInfo.textContent = `Durum: ${items.length} kayıt.`;

        if(items.length === 0){
          listEl.innerHTML = `<div class="reqCard"><b>Kayıt yok.</b></div>`;
          return;
        }

        for(const it of items){
          listEl.appendChild(renderItem(it));
        }
      }catch(e){
        log("LOAD LIST ERROR: " + (e?.message || e));
        countInfo.textContent = "Hata: Liste çekilemedi.";
      }
    }

    function safeText(v){
      if(v === null || v === undefined) return "-";
      const s = String(v).trim();
      return s ? s : "-";
    }

    function renderItem(it){
      const wrap = document.createElement("div");
      wrap.className = "reqCard";

      const name = safeText(it.name);
      const age = safeText(it.age);
      const sign = safeText(it.sign);
      const userId = safeText(it.userId);
      const createdAt = it.createdAt ? fmtDate(it.createdAt) : (it.createdAtText ? safeText(it.createdAtText) : "-");

      const photo1 = it.photo1Url || it.photo1 || it.image1Url || "";
      const photo2 = it.photo2Url || it.photo2 || it.image2Url || "";
      const status = safeText(it.status);

      wrap.innerHTML = `
        <div class="reqHead">
          <div>
            <h3 class="name">${name}</h3>
            <div class="chips">
              <span class="chip">Yaş: ${age}</span>
              <span class="chip">Burç: ${sign}</span>
              <span class="chip">Gönderim: ${createdAt}</span>
              <span class="chip">Durum: ${status}</span>
            </div>
          </div>
          <div class="muted small" style="text-align:right">
            <div><b>Doc:</b> ${it.id}</div>
            <div><b>UserId:</b> ${userId}</div>
          </div>
        </div>

        <div class="hr"></div>

        <div>
          <div style="font-weight:900;margin-bottom:8px">Fotoğraflar</div>
          <div class="photos">
            ${photo1 ? `<a href="${photo1}" target="_blank" rel="noopener"><img class="thumb" src="${photo1}" alt="foto1"></a>` : `<div class="thumb"></div>`}
            ${photo2 ? `<a href="${photo2}" target="_blank" rel="noopener"><img class="thumb" src="${photo2}" alt="foto2"></a>` : `<div class="thumb"></div>`}
            <button class="dark" data-copy>Resimleri Kopyala</button>
          </div>
          <div class="small muted" style="margin-top:6px">Resme tıklayınca büyük açılır.</div>
        </div>

        <div class="hr"></div>

        <div>
          <div style="font-weight:900;margin-bottom:8px">Fal Yorumu (zorunlu)</div>
          <textarea placeholder="Admin fal yorumunu buraya yazacak..."></textarea>
          <div class="actions">
            <button class="ok" data-approve>Onayla (readings'e taşı)</button>
            <button class="bad" data-reject>Reddet</button>
          </div>
          <div class="small muted">Not: Yorum boşsa onaylamaz.</div>
        </div>
      `;

      // Events
      const btnCopy = wrap.querySelector("[data-copy]");
      const btnApprove = wrap.querySelector("[data-approve]");
      const btnReject = wrap.querySelector("[data-reject]");
      const ta = wrap.querySelector("textarea");

      btnCopy.addEventListener("click", async () => {
        const txt = [
          `Foto1: ${photo1 || "-"}`,
          `Foto2: ${photo2 || "-"}`
        ].join("\n");
        try{
          await navigator.clipboard.writeText(txt);
          btnCopy.textContent = "Kopyalandı";
          setTimeout(()=> btnCopy.textContent="Resimleri Kopyala", 1200);
        }catch{
          alert("Kopyalama başarısız. iPhone bazen izin vermiyor.");
        }
      });

      btnApprove.addEventListener("click", async () => {
        if(!isAdmin){ alert("Admin değilsin."); return; }
        const readingText = ta.value.trim();
        if(!readingText){
          alert("Yorum zorunlu. Boş bırakamazsın.");
          return;
        }
        btnApprove.disabled = true;
        btnReject.disabled = true;
        try{
          // 1) readings/{sameId} oluştur / güncelle
          const readingRef = doc(db, "readings", it.id);
          await setDoc(readingRef, {
            ...it,
            status: "approved",
            readingText,
            approvedAt: serverTimestamp(),
            approvedBy: currentUser.uid,
            approvedByEmail: currentUser.email || null
          }, { merge: true });

          // 2) uploads/{id} status=approved yap (istersen sonra bu dokümanı silebiliriz)
          const uploadRef = doc(db, "uploads", it.id);
          await updateDoc(uploadRef, {
            status: "approved",
            readingText,
            approvedAt: serverTimestamp(),
            approvedBy: currentUser.uid,
            approvedByEmail: currentUser.email || null
          });

          wrap.style.opacity = "0.6";
          btnApprove.textContent = "Onaylandı";
          log(`APPROVED: ${it.id}`);
          await loadList();
        }catch(e){
          log("APPROVE ERROR: " + (e?.message || e));
          alert("Onay hata verdi. Debug'e bak.");
        }finally{
          btnApprove.disabled = false;
          btnReject.disabled = false;
        }
      });

      btnReject.addEventListener("click", async () => {
        if(!isAdmin){ alert("Admin değilsin."); return; }
        const reason = prompt("Reddetme nedeni (opsiyonel):") || "";
        btnApprove.disabled = true;
        btnReject.disabled = true;
        try{
          const uploadRef = doc(db, "uploads", it.id);
          await updateDoc(uploadRef, {
            status: "rejected",
            rejectedAt: serverTimestamp(),
            rejectedBy: currentUser.uid,
            rejectedByEmail: currentUser.email || null,
            rejectReason: reason.trim() || null
          });
          wrap.style.opacity = "0.6";
          btnReject.textContent = "Reddedildi";
          log(`REJECTED: ${it.id}`);
          await loadList();
        }catch(e){
          log("REJECT ERROR: " + (e?.message || e));
          alert("Reddet hata verdi. Debug'e bak.");
        }finally{
          btnApprove.disabled = false;
          btnReject.disabled = false;
        }
      });

      return wrap;
    }

    // Events
    btnGoogleLogin.addEventListener("click", async () => {
      try{
        log("LOGIN: signInWithRedirect (Google) ...");
        await signInWithRedirect(auth, provider);
      }catch(e){
        log("LOGIN ERROR: " + (e?.message || e));
        alert("Google giriş hata verdi. Debug'e bak.");
      }
    });

    btnLogout.addEventListener("click", async () => {
      try{
        await signOut(auth);
        log("LOGOUT: ok");
      }catch(e){
        log("LOGOUT ERROR: " + (e?.message || e));
      }
    });

    tabPending.addEventListener("click", async () => {
      viewMode = "pending";
      tabPending.classList.add("active");
      tabLast.classList.remove("active");
      await loadList();
    });

    tabLast.addEventListener("click", async () => {
      viewMode = "last";
      tabLast.classList.add("active");
      tabPending.classList.remove("active");
      await loadList();
    });

    btnRefresh.addEventListener("click", loadList);

    // Boot: redirect result + auth state
    (async () => {
      try{
        log("BOOT: getRedirectResult() ...");
        const res = await getRedirectResult(auth);
        if(res?.user){
          log("REDIRECT RESULT: user geldi -> " + (res.user.email || "-"));
        }else{
          log("REDIRECT RESULT: boş (normal olabilir)");
        }
      }catch(e){
        log("REDIRECT ERROR: " + (e?.message || e));
      }

      onAuthStateChanged(auth, async (user) => {
        log("AUTH STATE: " + (user ? "signed in" : "signed out"));
        await refreshAuthUI(user);
      });
    })();
  </script>
</body>
</html>