<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Falhane Admin</title>

  <style>
    :root{
      --bg:#f4f6fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;
      --primary:#2563eb;
      --dark:#0b1220;
      --danger:#ef4444;
      --radius:18px;
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:var(--bg);
      color:var(--text);
    }
    .container{ max-width: 980px; margin:0 auto; padding: 18px 14px 50px; }
    h1{
      margin: 10px 0 16px;
      font-size: clamp(32px, 6vw, 54px);
      line-height: 1.05;
      letter-spacing: -0.02em;
    }
    .panel{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(15, 23, 42, .06);
      padding: 16px;
      margin-bottom: 14px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 14px;
      border: 1px solid var(--border);
    }
    .badge-ok{ background:#ecfdf5; color:#065f46; border-color:#bbf7d0;}
    .badge-no{ background:#fef2f2; color:#991b1b; border-color:#fecaca;}
    .muted{ color: var(--muted); }

    .btn{
      appearance:none;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 800;
      cursor: pointer;
      line-height:1;
      white-space: nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{ background: var(--primary); color:#fff; border-color: transparent; }
    .btn-dark{ background: var(--dark); color:#fff; border-color: transparent; }
    .btn-danger{ background: var(--danger); color:#fff; border-color: transparent; }
    .btn-sm{ padding: 10px 12px; border-radius: 12px; font-size: 14px; }

    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .row .spacer{ flex:1 1 auto; }

    .input{
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 14px;
      font-size: 16px;
      outline: none;
    }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 760px){ .grid2{ grid-template-columns: 1fr; } }

    /* Pending card */
    .pending-card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      margin-top: 12px;
    }
    .pending-grid{
      display:grid;
      grid-template-columns: 1.4fr 1fr 0.9fr;
      gap: 14px;
      align-items: start;
    }
    @media (max-width: 760px){
      .pending-grid{ grid-template-columns: 1fr; }
    }

    .pending-info h3{
      margin: 0 0 8px;
      font-size: 22px;
      line-height: 1.15;
    }
    .kv{
      display:grid;
      grid-template-columns: 92px 1fr;
      gap: 6px 10px;
      font-size: 15px;
      color: var(--muted);
    }
    .kv b{ color: var(--text); }

    .wrap-anywhere{ overflow-wrap:anywhere; word-break: break-word; }

    .thumbs{ display:flex; gap: 10px; flex-wrap: wrap; }
    .thumb{
      width: 86px; height: 86px;
      border-radius: 14px;
      object-fit: cover;
      border: 1px solid var(--border);
      background:#fff;
    }
    .thumb-note{ font-size: 12px; color: var(--muted); margin-top: 6px; }

    .actions{ display:flex; flex-direction: column; gap: 10px; }
    @media (max-width: 760px){
      .actions{ flex-direction: row; flex-wrap: wrap; }
      .actions .btn{ flex: 1 1 160px; }
    }

    .divider{ height:1px; background: var(--border); margin: 12px 0; }

    .debug{
      background: #0b1220;
      color: #e2e8f0;
      padding: 12px 14px;
      border-radius: 14px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      white-space: pre-wrap;
      overflow-wrap: anywhere;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Admin İşlemleri</h1>

    <!-- ÜST PANEL -->
    <div class="panel">
      <div class="row">
        <span id="adminBadge" class="badge badge-no">Admin: HAYIR</span>
        <span class="spacer"></span>
        <button id="btnSignOutTop" class="btn btn-dark btn-sm" style="display:none;">Çıkış</button>
      </div>

      <p class="muted" style="margin:10px 0 0;">
        Not: Admin yetkisi için Firestore’da <b>admins/{UID}</b> dokümanı olmalı.
      </p>

      <!-- LOGIN FORM (GİRİŞ YOKSA GÖRÜNECEK) -->
      <div id="loginBox" style="margin-top:12px;">
        <div class="grid2">
          <div>
            <div class="muted" style="font-weight:800;margin:4px 0;">Email</div>
            <input id="email" class="input" type="email" placeholder="admin@mail.com" />
          </div>
          <div>
            <div class="muted" style="font-weight:800;margin:4px 0;">Şifre</div>
            <input id="pass" class="input" type="password" placeholder="••••••••" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button id="btnLogin" class="btn btn-primary">Giriş</button>
          <button id="btnSignOut" class="btn btn-dark">Çıkış</button>
          <span id="loginStatus" class="muted"></span>
        </div>
      </div>

      <!-- USER INFO (GİRİŞ VARSA GÖRÜNECEK) -->
      <div id="userBox" style="display:none; margin-top:12px;">
        <div style="font-weight:800;">Giriş yapan: <span id="whoEmail" class="wrap-anywhere"></span></div>
        <div class="muted" style="font-weight:800;">UID: <span id="whoUid" class="wrap-anywhere"></span></div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <button id="tabPending" class="btn btn-dark btn-sm">Bekleyen Fallar</button>
        <button id="tabLast50" class="btn btn-sm">Son 50 Upload (tümü)</button>
        <span class="spacer"></span>
        <button id="btnRefresh" class="btn btn-primary btn-sm">Yenile</button>
      </div>

      <div class="muted" style="margin-top:10px;">
        Durum: <span id="statusText">-</span>
      </div>
    </div>

    <!-- LİSTE -->
    <div id="list"></div>

    <!-- DEBUG -->
    <div class="panel">
      <div style="font-weight:900;margin-bottom:8px;">Debug</div>
      <div id="debug" class="debug">BOOT: -</div>
    </div>
  </div>

  <!-- Firebase (modular) -->
  <script type="module">
    // ============================
    // 1) BURAYA Firebase config gireceksin
    // Firebase Console > Project Settings > Your apps (Web) > config
    // ============================
    const firebaseConfig = {
      apiKey: "(SENİN apiKey)",
      authDomain: "(SENİN authDomain)",
      projectId: "(SENİN projectId)",
      storageBucket: "(SENİN storageBucket)",
      messagingSenderId: "(SENİN messagingSenderId)",
      appId: "(SENİN appId)"
    };

    // ============================
    // Imports
    // ============================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      signInWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    import {
      getFirestore, doc, getDoc,
      collection, query, where, orderBy, limit, getDocs,
      setDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ============================
    // Init
    // ============================
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ============================
    // UI helpers
    // ============================
    const $ = (id) => document.getElementById(id);

    const debugLines = [];
    function log(s){
      debugLines.push(String(s));
      $("debug").textContent = debugLines.slice(-25).join("\\n");
    }

    function fmtDate(ts){
      // Firestore Timestamp -> Date
      try{
        const d = ts?.toDate ? ts.toDate() : (ts instanceof Date ? ts : null);
        if(!d) return "-";
        const pad = (n) => String(n).padStart(2,"0");
        return `${d.getDate()}-${d.getMonth()+1}-${d.getFullYear()}, ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      } catch { return "-"; }
    }

    function setAdminBadge(isAdmin){
      const badge = $("adminBadge");
      badge.classList.remove("badge-ok","badge-no");
      if(isAdmin){
        badge.classList.add("badge-ok");
        badge.textContent = "Admin: EVET";
      }else{
        badge.classList.add("badge-no");
        badge.textContent = "Admin: HAYIR";
      }
    }

    // ============================
    // State
    // ============================
    let currentUser = null;
    let isAdmin = false;
    let activeTab = "pending"; // "pending" | "last50"

    // ============================
    // Auth UI
    // ============================
    async function checkAdmin(uid){
      // admins/{uid} dokümanı varsa admin
      const ref = doc(db, "admins", uid);
      const snap = await getDoc(ref);
      return snap.exists();
    }

    function showLoggedOut(){
      $("loginBox").style.display = "block";
      $("userBox").style.display = "none";
      $("btnSignOutTop").style.display = "none";
      $("statusText").textContent = "Oturum kapalı.";
      setAdminBadge(false);
      $("list").innerHTML = "";
    }

    function showLoggedIn(){
      $("loginBox").style.display = "none";    // GİRİŞ FORMU GİDİYOR
      $("userBox").style.display = "block";
      $("btnSignOutTop").style.display = "inline-flex";
      $("whoEmail").textContent = currentUser?.email || "-";
      $("whoUid").textContent = currentUser?.uid || "-";
    }

    // ============================
    // Data fetch
    // uploads koleksiyonu: pending item’lar burada
    // readings koleksiyonu: admin onaylayınca buraya taşınır (senin önceki sistemin)
    // ============================
    async function loadPending(){
      $("statusText").textContent = "Bekleyenler yükleniyor...";
      $("list").innerHTML = "";

      // uploads içinde status == "pending" gibi bir alan kullanıyorsan:
      // Eğer sende farklıysa where kısmını değiştir.
      const qy = query(
        collection(db, "uploads"),
        where("status", "==", "pending"),
        orderBy("createdAt", "desc"),
        limit(50)
      );

      const snap = await getDocs(qy);
      $("statusText").textContent = `${snap.size} bekleyen fal.`;

      if(snap.empty){
        $("list").innerHTML = `<div class="panel"><b>Bekleyen yok.</b></div>`;
        return;
      }

      snap.forEach((d) => {
        const data = d.data();

        const name = data?.name || data?.ad || "-";
        const age  = data?.age || data?.yas || "-";
        const zodiac = data?.zodiac || data?.burc || "-";

        const createdAt = data?.createdAt || data?.submittedAt || null;
        const createdText = fmtDate(createdAt);

        const userId = data?.userId || data?.uid || "-";
        const photo1 = data?.photo1Url || data?.foto1Url || data?.photo1 || data?.foto1 || "";
        const photo2 = data?.photo2Url || data?.foto2Url || data?.photo2 || data?.foto2 || "";

        const card = document.createElement("div");
        card.className = "pending-card";
        card.innerHTML = `
          <div class="pending-grid">
            <div class="pending-info">
              <h3 class="wrap-anywhere">${escapeHtml(name)}</h3>
              <div class="kv">
                <div>Yaş:</div><div><b>${escapeHtml(String(age))}</b></div>
                <div>Burç:</div><div><b class="wrap-anywhere">${escapeHtml(String(zodiac))}</b></div>
                <div>Gönderim:</div><div><b>${escapeHtml(createdText)}</b></div>
                <div>UserId:</div><div class="wrap-anywhere"><b>${escapeHtml(String(userId))}</b></div>
              </div>
            </div>

            <div>
              <div class="thumbs">
                ${photo1 ? `<a href="${photo1}" target="_blank" rel="noopener"><img class="thumb" src="${photo1}" alt="Foto 1"></a>` : ``}
                ${photo2 ? `<a href="${photo2}" target="_blank" rel="noopener"><img class="thumb" src="${photo2}" alt="Foto 2"></a>` : ``}
              </div>
              <div class="thumb-note">${(photo1||photo2) ? "Resme tıklayınca büyük açılır." : "Foto yok."}</div>
            </div>

            <div class="actions">
              <button class="btn btn-dark btn-sm" data-copy="${encodeAttr(`${photo1}\\n${photo2}`)}">Resimleri Kopyala</button>
              <button class="btn btn-primary btn-sm" data-approve="${d.id}">Onayla</button>
              <button class="btn btn-danger btn-sm" data-reject="${d.id}">Reddet</button>
            </div>
          </div>
        `;
        $("list").appendChild(card);
      });
    }

    async function loadLast50(){
      $("statusText").textContent = "Son 50 yükleniyor...";
      $("list").innerHTML = "";

      const qy = query(
        collection(db, "uploads"),
        orderBy("createdAt", "desc"),
        limit(50)
      );

      const snap = await getDocs(qy);
      $("statusText").textContent = `Son 50: ${snap.size} kayıt.`;

      if(snap.empty){
        $("list").innerHTML = `<div class="panel"><b>Kayıt yok.</b></div>`;
        return;
      }

      snap.forEach((d) => {
        const data = d.data();
        const name = data?.name || data?.ad || "-";
        const age  = data?.age || data?.yas || "-";
        const zodiac = data?.zodiac || data?.burc || "-";
        const createdText = fmtDate(data?.createdAt || null);
        const userId = data?.userId || data?.uid || "-";
        const status = data?.status || "-";

        const card = document.createElement("div");
        card.className = "panel";
        card.innerHTML = `
          <div style="font-weight:900">${escapeHtml(name)} <span class="muted" style="font-weight:700">(${escapeHtml(status)})</span></div>
          <div class="muted">Yaş: <b>${escapeHtml(String(age))}</b> | Burç: <b>${escapeHtml(String(zodiac))}</b></div>
          <div class="muted">Gönderim: <b>${escapeHtml(createdText)}</b></div>
          <div class="muted wrap-anywhere">UserId: <b>${escapeHtml(String(userId))}</b></div>
        `;
        $("list").appendChild(card);
      });
    }

    async function refresh(){
      if(!currentUser){
        $("statusText").textContent = "Oturum kapalı.";
        $("list").innerHTML = "";
        return;
      }
      if(!isAdmin){
        $("statusText").textContent = "Giriş var ama admin değilsin.";
        $("list").innerHTML = "";
        return;
      }
      if(activeTab === "pending") await loadPending();
      else await loadLast50();
    }

    // ============================
    // Approve / Reject
    // ============================
    async function approveUpload(uploadId){
      if(!isAdmin) return alert("Admin değilsin.");
      const upRef = doc(db, "uploads", uploadId);
      const upSnap = await getDoc(upRef);
      if(!upSnap.exists()) return alert("Kayıt bulunamadı.");

      const data = upSnap.data();

      // readings'e kopyala
      // (istersen id aynı kalsın diye uploadId kullanıyorum)
      const rdRef = doc(db, "readings", uploadId);
      await setDoc(rdRef, {
        ...data,
        status: "approved",
        approvedAt: new Date(),
        approvedBy: currentUser.uid
      }, { merge: true });

      // uploads status update
      await setDoc(upRef, {
        status: "approved",
        approvedAt: new Date(),
        approvedBy: currentUser.uid
      }, { merge: true });

      alert("Onaylandı (readings'e yazıldı).");
      await refresh();
    }

    async function rejectUpload(uploadId){
      if(!isAdmin) return alert("Admin değilsin.");
      const upRef = doc(db, "uploads", uploadId);

      // basit: status rejected
      await setDoc(upRef, {
        status: "rejected",
        rejectedAt: new Date(),
        rejectedBy: currentUser.uid
      }, { merge: true });

      alert("Reddedildi.");
      await refresh();
    }

    // ============================
    // Click handlers
    // ============================
    document.addEventListener("click", async (e) => {
      // kopyala
      const c = e.target.closest("[data-copy]");
      if(c){
        const text = c.getAttribute("data-copy") || "";
        try{
          await navigator.clipboard.writeText(text.replace(/\\n/g,"\n"));
          c.textContent = "Kopyalandı";
          setTimeout(()=> c.textContent = "Resimleri Kopyala", 1200);
        } catch {
          alert("Kopyalama başarısız (iPhone Safari bazen izin vermez).");
        }
      }

      // approve
      const a = e.target.closest("[data-approve]");
      if(a){
        const id = a.getAttribute("data-approve");
        await approveUpload(id);
      }

      // reject
      const r = e.target.closest("[data-reject]");
      if(r){
        const id = r.getAttribute("data-reject");
        await rejectUpload(id);
      }
    });

    $("btnLogin").addEventListener("click", async () => {
      const email = $("email").value.trim();
      const pass  = $("pass").value;
      $("loginStatus").textContent = "Giriş deneniyor...";
      try{
        await signInWithEmailAndPassword(auth, email, pass);
        $("loginStatus").textContent = "Giriş OK.";
      }catch(err){
        $("loginStatus").textContent = "Hata: " + (err?.code || err?.message || err);
        log("LOGIN ERROR: " + (err?.code || err?.message || err));
      }
    });

    $("btnSignOut").addEventListener("click", async () => {
      await signOut(auth);
    });
    $("btnSignOutTop").addEventListener("click", async () => {
      await signOut(auth);
    });

    $("tabPending").addEventListener("click", async () => {
      activeTab = "pending";
      $("tabPending").classList.add("btn-dark");
      $("tabLast50").classList.remove("btn-dark");
      await refresh();
    });

    $("tabLast50").addEventListener("click", async () => {
      activeTab = "last50";
      $("tabLast50").classList.add("btn-dark");
      $("tabPending").classList.remove("btn-dark");
      await refresh();
    });

    $("btnRefresh").addEventListener("click", refresh);

    // ============================
    // Auth state
    // ============================
    log("BOOT: url=" + location.href);

    onAuthStateChanged(auth, async (user) => {
      currentUser = user || null;

      if(!currentUser){
        isAdmin = false;
        showLoggedOut();
        log("AUTH STATE: signed out");
        return;
      }

      showLoggedIn();
      log("AUTH STATE: signed in");
      log("EMAIL: " + (currentUser.email || "-"));
      log("UID: " + currentUser.uid);

      // admin check
      isAdmin = await checkAdmin(currentUser.uid);
      setAdminBadge(isAdmin);
      log("ADMIN CHECK: " + (isAdmin ? "OK" : "NO"));

      await refresh();
    });

    // ============================
    // Small helpers
    // ============================
    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function encodeAttr(str){
      return escapeHtml(str).replaceAll('"',"&quot;");
    }
  </script>
</body>
</html>