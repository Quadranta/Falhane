<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin İşlemleri</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#f3f6fb;color:#111}
    .wrap{max-width:980px;margin:0 auto;padding:22px}
    h1{font-size:44px;line-height:1.05;margin:12px 0 16px}
    .card{background:#fff;border:1px solid #e6e8ef;border-radius:18px;padding:16px 16px 18px;margin:14px 0;box-shadow:0 6px 24px rgba(12,19,33,.06)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{border:0;border-radius:14px;padding:10px 14px;font-weight:800;cursor:pointer}
    .btnPrimary{background:#2563eb;color:#fff}
    .btnGhost{background:#e9eefb;color:#0f172a}
    .btnDanger{background:#111827;color:#fff}
    .btnOk{background:#16a34a;color:#fff}
    .btnBad{background:#ef4444;color:#fff}
    .pill{display:inline-block;background:#eef2ff;color:#1e3a8a;padding:8px 10px;border-radius:999px;font-weight:900}
    .muted{color:#64748b}
    .warn{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;padding:10px 12px;border-radius:14px;font-weight:800}
    .debug{white-space:pre-wrap;background:#0b1220;color:#e5e7eb;border-radius:16px;padding:12px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
    .listItem{border:1px solid #e6e8ef;border-radius:18px;padding:14px;margin:10px 0;background:#fff}
    textarea{width:100%;min-height:110px;border-radius:14px;border:1px solid #e5e7eb;padding:12px;font-size:15px}
    .thumbs{display:flex;gap:10px;align-items:center;justify-content:flex-end}
    .thumbs img{width:76px;height:76px;border-radius:14px;object-fit:cover;border:1px solid #e6e8ef}
    .right{margin-left:auto}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Admin İşlemleri</h1>

  <div id="banner" class="warn" style="display:none"></div>

  <div class="card">
    <div class="row">
      <div class="pill" id="adminPill">Admin: HAYIR</div>
      <div class="pill" id="loginPill">Giriş yapan: -</div>
      <div class="pill" id="uidPill">UID: -</div>
      <div class="right row">
        <button class="btn btnPrimary" id="btnGoogle">Google ile giriş</button>
        <button class="btn btnDanger" id="btnLogout">Çıkış</button>
      </div>
    </div>
    <div class="muted" style="margin-top:10px">
      Not: Admin yetkisi için Firestore'da <b>admins/{UID}</b> dokümanı olmalı.
    </div>
    <div class="muted" id="statusLine" style="margin-top:8px">Durum: Oturum kapalı.</div>
  </div>

  <div class="card">
    <div class="row">
      <button class="btn btnDanger" id="btnPending">Bekleyen Fallar</button>
      <button class="btn btnGhost" id="btnAll">Son 50 (tümü)</button>
      <button class="btn btnPrimary right" id="btnRefresh">Yenile</button>
    </div>
    <div class="muted" id="countLine" style="margin-top:10px">Durum: Oturum kapalı.</div>
    <div id="list"></div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 10px">Debug</h2>
    <div class="debug" id="debugBox">Hazır.</div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signOut,
    GoogleAuthProvider, signInWithPopup,
    setPersistence, browserLocalPersistence
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, collection, query, where, orderBy, limit, getDocs,
    updateDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBDTN_8sf9P7uwtnRqBTmlszcztb36g-XA",
    authDomain: "falhane-e3057.firebaseapp.com",
    projectId: "falhane-e3057",
    storageBucket: "falhane-e3057.firebasestorage.app",
    messagingSenderId: "117754512778",
    appId: "1:117754512778:web:52aee440472568bc6cb473",
    measurementId: "G-94TZ14VWPX"
  };

  const $ = (id)=>document.getElementById(id);
  const log = (s)=>$("debugBox").textContent = String(s);
  const banner = (s)=>{ $("banner").style.display = s ? "block":"none"; $("banner").textContent = s||""; };

  function fmtDate(ts){
    try{
      if(!ts) return "-";
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      const pad=(n)=>String(n).padStart(2,"0");
      return `${pad(d.getDate())}-${pad(d.getMonth()+1)}-${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }catch{return "-";}
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  log("BOOT: admin\nBOOT: persistence=browserLocalPersistence");
  await setPersistence(auth, browserLocalPersistence);

  let isAdmin = false;
  let mode = "pending"; // pending | all

  $("btnGoogle").onclick = async ()=>{
    try{
      banner("");
      const provider = new GoogleAuthProvider();
      provider.setCustomParameters({ prompt: "select_account" });
      log($("debugBox").textContent + "\nLOGIN: popup...");
      await signInWithPopup(auth, provider);
      log($("debugBox").textContent + "\nLOGIN: OK");
    }catch(e){
      const msg = e?.code || e?.message || String(e);
      banner("Google giriş başarısız: " + msg);
      log($("debugBox").textContent + "\nLOGIN ERROR: " + msg);
    }
  };

  $("btnLogout").onclick = async ()=>{ await signOut(auth); };

  $("btnPending").onclick = ()=>{ mode="pending"; refresh(); };
  $("btnAll").onclick = ()=>{ mode="all"; refresh(); };
  $("btnRefresh").onclick = refresh;

  onAuthStateChanged(auth, async (user)=>{
    if(!user){
      isAdmin = false;
      $("adminPill").textContent = "Admin: HAYIR";
      $("loginPill").textContent = "Giriş yapan: -";
      $("uidPill").textContent = "UID: -";
      $("statusLine").textContent = "Durum: Oturum kapalı.";
      $("countLine").textContent = "Durum: Oturum kapalı.";
      $("list").innerHTML = "";
      return;
    }

    $("loginPill").textContent = "Giriş yapan: " + (user.email || "-");
    $("uidPill").textContent = "UID: " + (user.uid || "-");

    // Admin check: admins/{uid} var mı?
    const aRef = doc(db, "admins", user.uid);
    const aSnap = await getDoc(aRef);
    isAdmin = aSnap.exists();

    $("adminPill").textContent = "Admin: " + (isAdmin ? "EVET" : "HAYIR");
    $("adminPill").style.background = isAdmin ? "#dcfce7" : "#fee2e2";
    $("adminPill").style.color = isAdmin ? "#14532d" : "#7f1d1d";

    $("statusLine").textContent = isAdmin ? "Durum: Giriş OK. Admin ise listeleyebilirsin." : "Durum: Admin değilsin.";
    await refresh();
  });

  async function refresh(){
    try{
      banner("");
      const user = auth.currentUser;
      if(!user){ $("countLine").textContent="Durum: Oturum kapalı."; return; }
      if(!isAdmin){ $("countLine").textContent="Durum: Admin değilsin."; $("list").innerHTML=""; return; }

      $("countLine").textContent = "Yükleniyor...";

      let q;
      if(mode === "pending"){
        q = query(
          collection(db,"uploads"),
          where("status","==","pending"),
          orderBy("createdAt","desc"),
          limit(50)
        );
      } else {
        q = query(
          collection(db,"uploads"),
          orderBy("createdAt","desc"),
          limit(50)
        );
      }

      const snap = await getDocs(q);
      const items=[];
      snap.forEach(d=>items.push({id:d.id, ...d.data()}));

      $("countLine").textContent = `Durum: ${items.length} kayıt. (${mode==="pending" ? "bekleyen" : "tümü"})`;
      $("list").innerHTML = items.map(renderItem).join("");
      bindRowButtons(items);
      log($("debugBox").textContent + "\nREFRESH OK: " + items.length);
    }catch(e){
      const msg = e?.message || e?.code || String(e);
      log($("debugBox").textContent + "\nREFRESH ERROR: " + msg);

      if (String(msg).includes("requires an index") || String(msg).includes("FAILED_PRECONDITION")) {
        banner("Firestore index lazım. Hata mesajındaki linkten Create Index yap.");
      } else {
        banner("Hata: " + msg);
      }
    }
  }

  function renderItem(x){
    const created = fmtDate(x.createdAt);
    const status = x.status || "-";
    const sign = x.sign || "-";
    const st = x.statusText || "";
    const comment = x.comment || "";

    return `
      <div class="listItem" id="row_${x.id}">
        <div class="row">
          <div style="font-size:22px;font-weight:900">${escapeHtml(x.name || "-")}</div>
          <div class="right thumbs">
            <a href="${x.photo1 || "#"}" target="_blank" rel="noreferrer"><img src="${x.photo1 || ""}" alt="p1"/></a>
            <a href="${x.photo2 || "#"}" target="_blank" rel="noreferrer"><img src="${x.photo2 || ""}" alt="p2"/></a>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <span class="pill">Yaş: ${escapeHtml(String(x.age ?? "-"))}</span>
          <span class="pill">Burç: ${escapeHtml(sign)}</span>
          <span class="pill">Gönderim: ${escapeHtml(created)}</span>
          <span class="pill">Durum: ${escapeHtml(status)}</span>
        </div>

        <div class="muted" style="margin-top:10px">${escapeHtml(st)}</div>

        <div style="margin-top:12px">
          <b>Fal Yorumu (müşteri görecek)</b>
          <textarea id="c_${x.id}" placeholder="Fal yorumunu buraya yaz...">${escapeHtml(comment)}</textarea>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn btnGhost" data-copy="${x.id}">Resimleri Kopyala</button>
          <button class="btn btnOk" data-approve="${x.id}">Onayla + Yorumu Kaydet</button>
          <button class="btn btnBad" data-reject="${x.id}">Reddet</button>
        </div>

        <div class="muted small" style="margin-top:8px">
          UserId: ${escapeHtml(x.userId || "-")} | Doc: ${escapeHtml(x.id)}
        </div>
      </div>
    `;
  }

  function bindRowButtons(items){
    // copy
    document.querySelectorAll("[data-copy]").forEach(btn=>{
      btn.onclick = async ()=>{
        const id = btn.getAttribute("data-copy");
        const x = items.find(i=>i.id===id);
        if(!x) return;
        const txt = `Foto1: ${x.photo1 || ""}\nFoto2: ${x.photo2 || ""}`;
        await navigator.clipboard.writeText(txt);
        banner("Resim linkleri kopyalandı.");
      };
    });

    // approve
    document.querySelectorAll("[data-approve]").forEach(btn=>{
      btn.onclick = async ()=>{
        const id = btn.getAttribute("data-approve");
        const x = items.find(i=>i.id===id);
        if(!x) return;

        const user = auth.currentUser;
        const comment = document.getElementById("c_"+id).value.trim();
        if(!comment) { banner("Yorum boş olamaz."); return; }

        try{
          await updateDoc(doc(db,"uploads",id),{
            status: "approved",
            comment: comment,
            approvedAt: serverTimestamp(),
            approvedBy: user.uid
          });
          banner("Onaylandı. Müşteri geçmişinde yorumu görecek.");
          await refresh();
        }catch(e){
          banner("Onay hatası: " + (e?.message||e?.code||String(e)));
        }
      };
    });

    // reject
    document.querySelectorAll("[data-reject]").forEach(btn=>{
      btn.onclick = async ()=>{
        const id = btn.getAttribute("data-reject");
        try{
          await updateDoc(doc(db,"uploads",id),{
            status: "rejected",
            approvedAt: serverTimestamp(),
            approvedBy: auth.currentUser?.uid || null
          });
          banner("Reddedildi.");
          await refresh();
        }catch(e){
          banner("Reddet hatası: " + (e?.message||e?.code||String(e)));
        }
      };
    });
  }

</script>
</body>
</html>