<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Falhane Admin Panel</title>
  <style>
    :root { --bg:#f3f5f9; --card:#fff; --text:#111827; --muted:#6b7280; --blue:#2563eb; --dark:#0f172a; --ok:#065f46; --bad:#991b1b; --pill:#e5e7eb;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);}
    .wrap{max-width:820px;margin:0 auto;padding:24px;}
    h1{font-size:44px;line-height:1.05;margin:8px 0 18px;}
    .card{background:var(--card);border-radius:16px;padding:18px 18px;box-shadow:0 8px 24px rgba(0,0,0,.06);margin:14px 0;}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
    .btn{border:0;border-radius:12px;padding:14px 16px;font-weight:700;cursor:pointer;}
    .btn.blue{background:var(--blue);color:#fff;}
    .btn.dark{background:var(--dark);color:#fff;}
    .btn.gray{background:#374151;color:#fff;}
    .btn.red{background:#b91c1c;color:#fff;}
    .btn.small{padding:10px 12px;border-radius:10px;font-weight:700}
    input{width:100%;padding:14px 14px;border-radius:12px;border:1px solid #e5e7eb;font-size:16px;}
    .label{font-weight:700;margin-top:8px;margin-bottom:6px;}
    .muted{color:var(--muted);}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--pill);font-weight:800;font-size:13px;}
    .pill.pending{background:#fef3c7;color:#92400e;}
    .pill.approved{background:#d1fae5;color:var(--ok);}
    .pill.rejected{background:#fee2e2;color:var(--bad);}
    .notice{border-radius:14px;padding:12px 14px;font-weight:700;}
    .notice.ok{background:#d1fae5;color:#065f46;border:1px solid #a7f3d0;}
    .notice.bad{background:#fee2e2;color:#991b1b;border:1px solid #fecaca;}
    pre{white-space:pre-wrap;word-break:break-word;background:#0b1220;color:#e5e7eb;border-radius:14px;padding:14px;margin:0;}
    .list{display:flex;flex-direction:column;gap:12px;margin-top:10px;}
    .item{border:1px solid #eef2f7;border-radius:14px;padding:14px;}
    .itemTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;}
    .id{font-weight:900;font-size:18px;}
    .meta{font-size:13px;color:var(--muted);margin-top:6px;}
    .text{font-size:18px;margin:10px 0 10px;}
    .spacer{height:6px;}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Falhane Admin<br/>Panel</h1>

    <div id="statusBox" class="card">
      <div id="statusLine" class="notice ok">Durum: HazÄ±r</div>
      <div class="muted" style="margin-top:8px">Not: Admin yetkisi iÃ§in Firestoreâ€™da <b>admins/{UID}</b> dokÃ¼manÄ± olmalÄ± (Ã¶rn: role="admin").</div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px">Admin GiriÅŸ (Email/Password)</h2>
      <div class="label">Email</div>
      <input id="email" type="email" placeholder="Email" autocomplete="email" />
      <div class="label">Password</div>
      <input id="pass" type="password" placeholder="Password" autocomplete="current-password" />
      <div class="spacer"></div>
      <div class="row">
        <button id="btnLogin" class="btn blue" style="flex:1">GiriÅŸ</button>
        <button id="btnLogout" class="btn dark" style="flex:1">Ã‡Ä±kÄ±ÅŸ</button>
      </div>
      <div class="muted" style="margin-top:10px">
        Admin UID kontrolÃ¼: <b id="uidLine">-</b>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px">Admin Ä°ÅŸlemleri</h2>

      <div class="muted">
        GiriÅŸ yapan: <b id="whoLine">-</b> | UID: <b id="uidLine2">-</b>
      </div>

      <div class="spacer"></div>

      <div class="row">
        <button id="btnLoadPending" class="btn gray" style="flex:1">Pending Uploads YÃ¼kle</button>
        <button id="btnLoadLatest" class="btn gray" style="flex:1">Son 50 Upload (tÃ¼mÃ¼) yÃ¼kle</button>
      </div>

      <div class="muted" style="margin-top:10px">
        Durum: <b id="loadStatus">-</b>
      </div>

      <div id="list" class="list"></div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px">Debug</h2>
      <pre id="debug">HazÄ±r.</pre>
    </div>
  </div>

  <script type="module">
    // ---------- Firebase (v10 modular) ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      addDoc,
      updateDoc,
      serverTimestamp,
      query,
      where,
      orderBy,
      limit,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // âœ… Senin config (aynÄ± bÄ±rak)
    const firebaseConfig = {
      apiKey: "AIzaSyBDTN_8sf9P7uwtnRqBTmlszcztb36g-XA",
      authDomain: "falhane-e3057.firebaseapp.com",
      projectId: "falhane-e3057",
      storageBucket: "falhane-e3057.firebasestorage.app",
      messagingSenderId: "117754512778",
      appId: "1:117754512778:web:52aee440472568bc6cb473",
      measurementId: "G-94TZ14VWPX"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---------- UI helpers ----------
    const $ = (id) => document.getElementById(id);
    const debugEl = $("debug");

    function log(...args) {
      const msg = args.map(a => (typeof a === "string" ? a : JSON.stringify(a, null, 2))).join(" ");
      debugEl.textContent = (debugEl.textContent ? debugEl.textContent + "\n" : "") + msg;
    }

    function setStatus(ok, text) {
      const el = $("statusLine");
      el.className = "notice " + (ok ? "ok" : "bad");
      el.textContent = text;
    }

    function tsToText(v) {
      try {
        if (!v) return "-";
        if (typeof v === "string") return v;
        if (v.toDate) return v.toDate().toISOString();
        return String(v);
      } catch { return "-"; }
    }

    function pill(status) {
      const s = (status || "").toLowerCase();
      if (s === "approved") return `<span class="pill approved">approved</span>`;
      if (s === "rejected") return `<span class="pill rejected">rejected</span>`;
      return `<span class="pill pending">pending</span>`;
    }

    // ---------- Admin check ----------
    async function isAdmin(uid) {
      const ref = doc(db, "admins", uid);
      const snap = await getDoc(ref);
      return snap.exists();
    }

    // ---------- Load uploads ----------
    async function loadUploads(mode) {
      $("list").innerHTML = "";
      $("loadStatus").textContent = "YÃ¼kleniyor...";
      try {
        let q;

        if (mode === "pending") {
          q = query(
            collection(db, "uploads"),
            where("status", "==", "pending"),
            orderBy("createdAt", "desc"),
            limit(50)
          );
        } else {
          q = query(
            collection(db, "uploads"),
            orderBy("createdAt", "desc"),
            limit(50)
          );
        }

        const snap = await getDocs(q);
        const docs = [];
        snap.forEach(d => docs.push({ id: d.id, ...d.data() }));

        $("loadStatus").textContent = `Uploads yÃ¼klendi â€¢ ${mode === "pending" ? "pending" : "toplam"}: ${docs.length} (max 50)`;

        if (docs.length === 0) {
          $("list").innerHTML = `<div class="muted">KayÄ±t yok.</div>`;
          return;
        }

        for (const it of docs) {
          renderUploadItem(it);
        }
        setStatus(true, "Durum: Uploads yÃ¼klendi");
      } catch (e) {
        console.error(e);
        $("loadStatus").textContent = "HATA";
        setStatus(false, "Durum: Uploads okuma HATA");
        log("LOAD ERROR:", e?.message || e);
      }
    }

    // ---------- Approve -> readings ----------
    async function approveToReadings(uploadId) {
      const user = auth.currentUser;
      if (!user) {
        alert("Ã–nce admin giriÅŸ yap");
        return;
      }
      const uid = user.uid;
      const ok = await isAdmin(uid);
      if (!ok) {
        alert("Admin yetkin yok (admins/{uid} yok).");
        return;
      }

      try {
        // 1) uploads/{docId} oku
        const upRef = doc(db, "uploads", uploadId);
        const upSnap = await getDoc(upRef);
        if (!upSnap.exists()) {
          alert("Upload bulunamadÄ±");
          return;
        }
        const up = upSnap.data();

        // 2) readings iÃ§ine yeni dokÃ¼man yaz
        // ðŸ”´ burada userId KESÄ°NLÄ°KLE uploads iÃ§inden gelir
        const readingPayload = {
          text: up.text || "",
          userId: up.userId || "",          // kullanÄ±cÄ± UID burada olmalÄ±
          sourceUploadId: uploadId,
          status: "approved",
          createdAt: up.createdAt || serverTimestamp(),
          approvedAt: serverTimestamp(),
          approvedBy: uid
        };

        if (!readingPayload.userId) {
          alert("uploads.userId boÅŸ. Upload sÄ±rasÄ±nda userId 'test' gibi yanlÄ±ÅŸ kaydedilmiÅŸ olabilir.");
          return;
        }

        await addDoc(collection(db, "readings"), readingPayload);

        // 3) uploads status approved
        await updateDoc(upRef, {
          status: "approved",
          approvedAt: serverTimestamp(),
          approvedBy: uid
        });

        setStatus(true, `Durum: OnaylandÄ± â†’ readings (${uploadId})`);
        log("APPROVED:", { uploadId, readingUserId: readingPayload.userId });

        // listeyi yenile (pending ise dÃ¼ÅŸsÃ¼n)
        await loadUploads("pending");
      } catch (e) {
        console.error(e);
        setStatus(false, `Durum: Onay HATA (${uploadId})`);
        log("APPROVE ERROR:", e?.message || e);
        alert(e?.message || "Hata");
      }
    }

    async function rejectUpload(uploadId) {
      const user = auth.currentUser;
      if (!user) { alert("Ã–nce admin giriÅŸ yap"); return; }
      const uid = user.uid;
      const ok = await isAdmin(uid);
      if (!ok) { alert("Admin yetkin yok."); return; }

      try {
        const upRef = doc(db, "uploads", uploadId);
        await updateDoc(upRef, {
          status: "rejected",
          rejectedAt: serverTimestamp(),
          rejectedBy: uid
        });
        setStatus(true, `Durum: Reddedildi (${uploadId})`);
        log("REJECTED:", uploadId);
        await loadUploads("pending");
      } catch (e) {
        console.error(e);
        setStatus(false, `Durum: Red HATA (${uploadId})`);
        log("REJECT ERROR:", e?.message || e);
        alert(e?.message || "Hata");
      }
    }

    // ---------- Render ----------
    function renderUploadItem(it) {
      const el = document.createElement("div");
      el.className = "item";

      const createdAt = tsToText(it.createdAt);
      const userId = it.userId || "-";
      const status = it.status || "pending";
      const txt = (it.text || "").toString();

      el.innerHTML = `
        <div class="itemTop">
          <div>
            <div class="id">${it.id}</div>
            <div class="meta">userId: <b>${userId}</b> â€¢ createdAt: <b>${createdAt}</b></div>
          </div>
          <div>${pill(status)}</div>
        </div>

        <div class="text">${escapeHtml(txt)}</div>

        <div class="row">
          <button class="btn small blue" data-approve="${it.id}">Onayla â†’ readings</button>
          <button class="btn small red" data-reject="${it.id}">Reddet</button>
          <button class="btn small gray" data-json="${it.id}">JSON</button>
        </div>

        <div class="spacer"></div>
        <div id="json-${it.id}" style="display:none">
          <pre>${escapeHtml(JSON.stringify(it, null, 2))}</pre>
        </div>
      `;

      $("list").appendChild(el);

      el.querySelector(`[data-approve="${it.id}"]`).addEventListener("click", () => approveToReadings(it.id));
      el.querySelector(`[data-reject="${it.id}"]`).addEventListener("click", () => rejectUpload(it.id));
      el.querySelector(`[data-json="${it.id}"]`).addEventListener("click", () => {
        const j = document.getElementById(`json-${it.id}`);
        j.style.display = (j.style.display === "none") ? "block" : "none";
      });
    }

    function escapeHtml(s) {
      return (s ?? "").toString()
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // ---------- Auth UI ----------
    $("btnLogin").addEventListener("click", async () => {
      debugEl.textContent = "";
      const email = $("email").value.trim();
      const pass = $("pass").value;
      if (!email || !pass) { alert("Email ve ÅŸifre gir"); return; }

      try {
        const cred = await signInWithEmailAndPassword(auth, email, pass);
        log("LOGIN OK:", cred.user.uid);
      } catch (e) {
        console.error(e);
        setStatus(false, "Durum: GiriÅŸ HATA");
        log("LOGIN ERROR:", e?.message || e);
        alert(e?.message || "GiriÅŸ hatasÄ±");
      }
    });

    $("btnLogout").addEventListener("click", async () => {
      try {
        await signOut(auth);
        log("LOGOUT OK");
      } catch (e) {
        console.error(e);
        log("LOGOUT ERROR:", e?.message || e);
      }
    });

    $("btnLoadPending").addEventListener("click", () => loadUploads("pending"));
    $("btnLoadLatest").addEventListener("click", () => loadUploads("latest"));

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        $("uidLine").textContent = "-";
        $("uidLine2").textContent = "-";
        $("whoLine").textContent = "-";
        setStatus(true, "Durum: Oturum kapalÄ±");
        return;
      }

      $("uidLine").textContent = user.uid;
      $("uidLine2").textContent = user.uid;
      $("whoLine").textContent = user.email || "(email yok)";

      try {
        const ok = await isAdmin(user.uid);
        if (ok) {
          setStatus(true, "Durum: Admin giriÅŸ OK");
          log("ADMIN OK:", user.uid);
        } else {
          setStatus(false, "Durum: Bu kullanÄ±cÄ± admin deÄŸil (admins/{uid} yok)");
          log("NOT ADMIN:", user.uid);
        }
      } catch (e) {
        setStatus(false, "Durum: Admin kontrol HATA");
        log("ADMIN CHECK ERROR:", e?.message || e);
      }
    });

    log("BOOT: admin.html hazÄ±r.");
  </script>
</body>
</html>