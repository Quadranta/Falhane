<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Falhane Admin</title>
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#64748b; --b:#e5e7eb; --ok:#16a34a; --bad:#ef4444; --pri:#2563eb; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
    .wrap{ max-width:980px; margin:0 auto; padding:18px; }
    h1{ font-size:40px; margin:8px 0 16px; }
    .card{ background:var(--card); border:1px solid var(--b); border-radius:16px; padding:14px; margin:12px 0; box-shadow:0 8px 24px rgba(15,23,42,.06); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill{ display:inline-flex; gap:8px; align-items:center; padding:8px 12px; border-radius:999px; border:1px solid var(--b); background:#fff; font-weight:700; }
    .pill.ok{ border-color:#bbf7d0; background:#ecfdf5; color:#166534; }
    .pill.bad{ border-color:#fecaca; background:#fff1f2; color:#9f1239; }
    .btn{ border:0; border-radius:12px; padding:10px 14px; font-weight:800; cursor:pointer; }
    .btn.blue{ background:var(--pri); color:#fff; }
    .btn.gray{ background:#111827; color:#fff; }
    .btn.ok{ background:var(--ok); color:#fff; }
    .btn.bad{ background:var(--bad); color:#fff; }
    .btn.ghost{ background:#fff; border:1px solid var(--b); }
    .muted{ color:var(--muted); }
    .grid{ display:grid; gap:12px; }
    .item{ border:1px solid var(--b); border-radius:16px; padding:12px; background:#fff; }
    .itemHead{ display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center; }
    .name{ font-size:26px; font-weight:900; }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; }
    .chip{ background:#eef2ff; color:#1e3a8a; border:1px solid #dbeafe; padding:6px 10px; border-radius:999px; font-weight:800; }
    .meta{ display:grid; gap:6px; margin:10px 0; }
    .meta b{ font-family:ui-monospace,SFMono-Regular,Menlo,monospace; }
    .thumbs{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .thumb{ width:72px; height:72px; border-radius:12px; border:1px solid var(--b); object-fit:cover; background:#f1f5f9; cursor:pointer; }
    textarea{ width:100%; min-height:110px; border-radius:12px; border:1px solid var(--b); padding:10px; font-size:15px; }
    .debug{ background:#0b1220; color:#d1d5db; border-radius:16px; padding:12px; white-space:pre-wrap; font-family:ui-monospace,SFMono-Regular,Menlo,monospace; }
    .hide{ display:none!important; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Admin İşlemleri</h1>

    <div class="card">
      <div class="row">
        <div id="adminBadge" class="pill bad">Admin: HAYIR</div>
        <div class="pill">Giriş yapan: <span id="who">-</span></div>
        <div class="pill">UID: <span id="uid">-</span></div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnGoogle" class="btn blue">Google ile giriş</button>
        <button id="btnLogout" class="btn gray hide">Çıkış</button>
      </div>

      <div class="muted" style="margin-top:10px">
        Not: Admin yetkisi için Firestore’da <b>admins/{UID}</b> dokümanı olmalı ve <b>role="admin"</b> yazmalı.
        <div id="statusLine">Durum: Oturum kapalı.</div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <button id="tabPending" class="btn gray">Bekleyen Fallar</button>
        <button id="tabAll" class="btn ghost">Son 50 (tümü)</button>
        <button id="btnRefresh" class="btn blue">Yenile</button>
      </div>
      <div class="muted" style="margin-top:8px" id="countLine">Durum: -</div>
    </div>

    <div class="card">
      <div class="grid" id="list"></div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px">Debug</h2>
      <div id="dbg" class="debug">Hazır.</div>
    </div>
  </div>

  <script type="module">
    // ===== Firebase (SENİN CONFIG) =====
    const firebaseConfig = {
      apiKey: "AIzaSyBDTN_8sf9P7uwtnRqBTmlszcztb36g-XA",
      authDomain: "falhane-e3057.firebaseapp.com",
      projectId: "falhane-e3057",
      storageBucket: "falhane-e3057.firebasestorage.app",
      messagingSenderId: "117754512778",
      appId: "1:117754512778:web:52aee440472568bc6cb473",
      measurementId: "G-94TZ14VWPX"
    };

    // ===== Imports =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithRedirect, getRedirectResult,
      GoogleAuthProvider, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, collection, query, where, orderBy, limit, getDocs,
      updateDoc, serverTimestamp, addDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ===== Boot =====
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // ===== UI refs =====
    const $ = (id) => document.getElementById(id);
    const dbg = (s) => { $("dbg").textContent = (typeof s === "string" ? s : JSON.stringify(s,null,2)); };

    const btnGoogle = $("btnGoogle");
    const btnLogout = $("btnLogout");
    const who = $("who");
    const uid = $("uid");
    const adminBadge = $("adminBadge");
    const statusLine = $("statusLine");
    const list = $("list");
    const countLine = $("countLine");

    let IS_ADMIN = false;
    let MODE = "pending"; // pending | all

    function fmtDate(d) {
      const pad = (n)=>String(n).padStart(2,"0");
      return `${pad(d.getDate())}-${pad(d.getMonth()+1)}-${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function openImg(url){
      window.open(url, "_blank");
    }

    async function checkAdmin(user) {
      IS_ADMIN = false;
      adminBadge.className = "pill bad";
      adminBadge.textContent = "Admin: HAYIR";

      if (!user) return;

      const ref = doc(db, "admins", user.uid);
      const snap = await getDoc(ref);
      if (snap.exists() && snap.data()?.role === "admin") {
        IS_ADMIN = true;
        adminBadge.className = "pill ok";
        adminBadge.textContent = "Admin: EVET";
      }
    }

    // ===== Google login (redirect - iPhone Safari uyumlu) =====
    btnGoogle.addEventListener("click", async () => {
      try {
        dbg("LOGIN: Google redirect başlatılıyor...");
        await signInWithRedirect(auth, provider);
      } catch (e) {
        dbg(`LOGIN ERROR: ${e.code || ""} ${e.message || e}`);
      }
    });

    btnLogout.addEventListener("click", async () => {
      try {
        await signOut(auth);
      } catch (e) {
        dbg(`LOGOUT ERROR: ${e.code || ""} ${e.message || e}`);
      }
    });

    // Redirect dönüşünü yakala (boş olabilir, normal)
    try {
      const r = await getRedirectResult(auth);
      dbg("BOOT: getRedirectResult() ok.\nREDIRECT RESULT: " + (r?.user?.email || "boş (normal olabilir)"));
    } catch (e) {
      dbg(`REDIRECT ERROR: ${e.code || ""} ${e.message || e}`);
    }

    // ===== Auth state =====
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        who.textContent = "-";
        uid.textContent = "-";
        statusLine.textContent = "Durum: Oturum kapalı.";
        btnLogout.classList.add("hide");
        btnGoogle.classList.remove("hide");
        list.innerHTML = "";
        countLine.textContent = "Durum: Oturum kapalı.";
        return;
      }

      who.textContent = user.email || "(email yok)";
      uid.textContent = user.uid;
      statusLine.textContent = "Durum: Giriş OK. Admin isen listeleyebilirsin.";
      btnLogout.classList.remove("hide");
      btnGoogle.classList.add("hide");

      await checkAdmin(user);

      if (!IS_ADMIN) {
        countLine.textContent = "Admin değilsin. Firestore’da admins/{UID} role=admin olmalı.";
        list.innerHTML = "";
        return;
      }

      await loadList();
    });

    // ===== Tabs / Refresh =====
    $("tabPending").addEventListener("click", async () => { MODE="pending"; $("tabPending").className="btn gray"; $("tabAll").className="btn ghost"; await loadList(); });
    $("tabAll").addEventListener("click", async () => { MODE="all"; $("tabAll").className="btn gray"; $("tabPending").className="btn ghost"; await loadList(); });
    $("btnRefresh").addEventListener("click", loadList);

    // ===== Data load =====
    async function loadList() {
      try {
        const user = auth.currentUser;
        if (!user) return;
        await checkAdmin(user);
        if (!IS_ADMIN) return;

        list.innerHTML = "";
        countLine.textContent = "Yükleniyor...";

        // uploads koleksiyonu: pending veya hepsi
        let q;
        if (MODE === "pending") {
          q = query(
            collection(db, "uploads"),
            where("status", "==", "pending"),
            orderBy("createdAt", "desc"),
            limit(50)
          );
        } else {
          q = query(
            collection(db, "uploads"),
            orderBy("createdAt", "desc"),
            limit(50)
          );
        }

        const snap = await getDocs(q);
        countLine.textContent = `Durum: ${snap.size} kayıt.`;

        if (snap.empty) {
          list.innerHTML = `<div class="item muted">Kayıt yok.</div>`;
          return;
        }

        snap.forEach((docSnap) => {
          const d = docSnap.data() || {};
          const created = d.createdAt?.toDate ? d.createdAt.toDate() : null;
          const createdStr = created ? fmtDate(created) : "-";

          const name = d.name || "-";
          const age = (d.age ?? "-");
          const sign = d.sign || d.burc || "-";
          const userId = d.userId || "-";

          const photo1 = d.photo1Url || d.photo1 || "";
          const photo2 = d.photo2Url || d.photo2 || "";

          const el = document.createElement("div");
          el.className = "item";

          el.innerHTML = `
            <div class="itemHead">
              <div>
                <div class="name">${escapeHtml(name)}</div>
                <div class="chips">
                  <span class="chip">Yaş: ${escapeHtml(String(age))}</span>
                  <span class="chip">Burç: ${escapeHtml(String(sign))}</span>
                  <span class="chip">Gönderim: ${escapeHtml(createdStr)}</span>
                </div>
              </div>
              <div class="chips">
                <button class="btn ghost" data-copy>Resimleri Kopyala</button>
                <button class="btn ok" data-approve>Onayla</button>
                <button class="btn bad" data-reject>Reddet</button>
              </div>
            </div>

            <div class="meta">
              <div class="muted">UserId: <b>${escapeHtml(userId)}</b></div>
              <div class="muted">Doc: <b>${escapeHtml(docSnap.id)}</b></div>
            </div>

            <div class="muted" style="font-weight:800;margin:8px 0 6px">Fotoğraflar</div>
            <div class="thumbs">
              ${photo1 ? `<img class="thumb" data-img src="${photo1}" alt="foto1">` : `<div class="muted">Foto1 yok</div>`}
              ${photo2 ? `<img class="thumb" data-img src="${photo2}" alt="foto2">` : ``}
            </div>

            <div style="margin-top:10px">
              <div class="muted" style="font-weight:900;margin:0 0 6px">Fal Yorumu (müşteri görecek)</div>
              <textarea placeholder="Fal yorumunu buraya yaz...">${escapeHtmlTextarea(d.adminNote || d.readingText || "")}</textarea>
              <div class="row" style="margin-top:8px">
                <button class="btn blue" data-save>Yorumu Kaydet</button>
              </div>
              <div class="muted" style="margin-top:6px">Not: Onayladığında bu yorum “readings” içine taşınır ve müşteri panelinde görünür.</div>
            </div>
          `;

          // actions
          el.querySelector("[data-copy]").addEventListener("click", async () => {
            const txt = `Foto1: ${photo1 || "-"}\nFoto2: ${photo2 || "-"}`;
            await navigator.clipboard.writeText(txt);
            dbg("Kopyalandı:\n" + txt);
          });

          el.querySelectorAll("[data-img]").forEach(img=>{
            img.addEventListener("click", ()=>openImg(img.src));
          });

          el.querySelector("[data-save]").addEventListener("click", async () => {
            const note = el.querySelector("textarea").value.trim();
            await updateDoc(doc(db, "uploads", docSnap.id), {
              adminNote: note,
              updatedAt: serverTimestamp()
            });
            dbg("Yorum kaydedildi: " + docSnap.id);
          });

          el.querySelector("[data-reject]").addEventListener("click", async () => {
            const note = el.querySelector("textarea").value.trim();
            await updateDoc(doc(db, "uploads", docSnap.id), {
              status: "rejected",
              rejectedAt: serverTimestamp(),
              adminNote: note
            });
            dbg("Reddedildi: " + docSnap.id);
            await loadList();
          });

          el.querySelector("[data-approve]").addEventListener("click", async () => {
            const note = el.querySelector("textarea").value.trim();

            // readings kaydı oluştur (müşteri buradan görecek)
            await addDoc(collection(db, "readings"), {
              name, age, sign,
              userId,
              photo1Url: photo1 || null,
              photo2Url: photo2 || null,
              adminNote: note,
              createdAt: serverTimestamp(),
              uploadDocId: docSnap.id,
              approvedBy: auth.currentUser.uid
            });

            // upload status güncelle
            await updateDoc(doc(db, "uploads", docSnap.id), {
              status: "approved",
              approvedAt: serverTimestamp(),
              approvedBy: auth.currentUser.uid,
              adminNote: note
            });

            dbg("Onaylandı + readings oluşturuldu: " + docSnap.id);
            await loadList();
          });

          list.appendChild(el);
        });

      } catch (e) {
        dbg(`LOAD ERROR: ${e.code || ""} ${e.message || e}`);
        countLine.textContent = "Hata: " + (e.code || e.message || e);
      }
    }

    // ===== Helpers =====
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }
    function escapeHtmlTextarea(s){
      // textarea içinde HTML kaçışı gerekmez ama güvenli tutalım
      return String(s).replace(/</g,"&lt;").replace(/>/g,"&gt;");
    }
  </script>
</body>
</html>