<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Falhane Kullanıcı Paneli</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f6f7fb; margin:0; padding:20px; }
    h1 { margin: 0 0 16px; font-size: 44px; letter-spacing:-0.5px; }
    .card { background:#fff; border:1px solid #e6e8ef; border-radius:16px; padding:16px; margin: 12px 0; box-shadow: 0 8px 24px rgba(10,20,60,.06); }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    button { width:100%; padding:14px 16px; border:0; border-radius:12px; font-size:16px; font-weight:700; cursor:pointer; }
    .primary { background:#1f6feb; color:#fff; }
    .dark { background:#0b1220; color:#fff; }
    .muted { color:#666; font-size:13px; }
    .ok { background:#e8fff1; border:1px solid #b7f0c8; color:#116b2f; padding:12px; border-radius:12px; }
    .bad { background:#ffecec; border:1px solid #ffb9b9; color:#9b1c1c; padding:12px; border-radius:12px; white-space:pre-wrap; word-break:break-word; }
    pre { background:#0b1220; color:#d8e1ff; padding:12px; border-radius:12px; overflow:auto; }
    .item { border:1px solid #e6e8ef; border-radius:14px; padding:12px; margin:10px 0; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700; background:#eef2ff; color:#2a3a8c; }
  </style>
</head>

<body>
  <h1>Falhane Kullanıcı Paneli</h1>

  <div class="card" id="statusBox" style="display:none;"></div>

  <div class="card">
    <h2>Giriş (Google)</h2>
    <div class="row">
      <button class="primary" id="btnGoogle">Google ile giriş</button>
      <button class="dark" id="btnLogout">Çıkış</button>
    </div>
    <div class="muted" style="margin-top:10px;">
      Giriş yapan: <b id="who">-</b><br/>
      UID: <span id="uid">-</span>
    </div>
    <div class="muted" style="margin-top:8px;">
      Not: Bu sayfa sadece <b>readings</b> koleksiyonundan <b>kendi</b> kayıtlarını gösterir.
    </div>
  </div>

  <div class="card">
    <h2>Benim Fal Sonuçlarım (readings)</h2>
    <div class="row">
      <button class="primary" id="btnRefresh">Yenile</button>
    </div>
    <div class="muted" style="margin-top:8px;">Toplam: <b id="count">0</b></div>
    <div id="list"></div>
  </div>

  <div class="card">
    <h2>Debug</h2>
    <pre id="debug"></pre>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithRedirect,
      getRedirectResult,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    import {
      getFirestore,
      collection,
      query,
      where,
      orderBy,
      limit,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ✅ Senin config
    const firebaseConfig = {
      apiKey: "AIzaSyBDTN_8sf9P7uwtnRqBTmlszcztb36g-XA",
      authDomain: "falhane-e3057.firebaseapp.com",
      projectId: "falhane-e3057",
      storageBucket: "falhane-e3057.firebasestorage.app",
      messagingSenderId: "117754512778",
      appId: "1:117754512778:web:52aee440472568bc6cb473",
      measurementId: "G-94TZ14VWPX"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // UI
    const statusBox = document.getElementById("statusBox");
    const who = document.getElementById("who");
    const uidEl = document.getElementById("uid");
    const list = document.getElementById("list");
    const countEl = document.getElementById("count");
    const debugEl = document.getElementById("debug");

    function setStatus(kind, msg) {
      statusBox.style.display = "block";
      statusBox.className = kind === "ok" ? "ok" : "bad";
      statusBox.textContent = msg;
    }

    function setDebug(obj) {
      debugEl.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
    }

    async function loadMyReadings() {
      const u = auth.currentUser;
      if (!u) {
        setStatus("bad", "Okuma HATA: Önce giriş yap.");
        return;
      }

      try {
        // ✅ Bu sorgu composite index ister:
        // readings: where(userId==uid) + orderBy(createdAt desc)
        const q = query(
          collection(db, "readings"),
          where("userId", "==", u.uid),
          orderBy("createdAt", "desc"),
          limit(50)
        );

        const snap = await getDocs(q);
        const rows = [];
        snap.forEach(d => rows.push({ id: d.id, ...d.data() }));

        countEl.textContent = String(rows.length);
        list.innerHTML = "";

        rows.forEach(r => {
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = `
            <div style="display:flex; justify-content:space-between; gap:10px;">
              <div><b>${r.id}</b></div>
              <span class="pill">reading</span>
            </div>
            <div class="muted" style="margin-top:6px;">
              createdAt: ${r.createdAt?.seconds ? new Date(r.createdAt.seconds * 1000).toISOString() : "-"}
            </div>
            <div style="margin-top:10px; font-size:18px;">${(r.text ?? "").toString()}</div>
          `;
          list.appendChild(div);
        });

        setStatus("ok", "Okuma başarılı");
        setDebug({ count: rows.length, firstId: rows[0]?.id ?? null });

      } catch (e) {
        // Index hatası buraya düşer
        setStatus("bad", "Okuma HATA: " + (e?.message || e));
        setDebug(String(e?.stack || e));
      }
    }

    // Buttons
    document.getElementById("btnGoogle").addEventListener("click", async () => {
      try {
        await signInWithRedirect(auth, provider);
      } catch (e) {
        setStatus("bad", "Giriş HATA: " + (e?.message || e));
        setDebug(String(e?.stack || e));
      }
    });

    document.getElementById("btnLogout").addEventListener("click", async () => {
      await signOut(auth);
      setStatus("ok", "Çıkış yapıldı.");
      who.textContent = "-";
      uidEl.textContent = "-";
      list.innerHTML = "";
      countEl.textContent = "0";
      setDebug({});
    });

    document.getElementById("btnRefresh").addEventListener("click", loadMyReadings);

    // Redirect dönüşü
    getRedirectResult(auth).catch(() => { /* sessiz geç */ });

    onAuthStateChanged(auth, (u) => {
      if (u) {
        who.textContent = u.email || u.displayName || "(no email)";
        uidEl.textContent = u.uid;
        setStatus("ok", "Giriş başarılı");
        loadMyReadings();
      } else {
        who.textContent = "-";
        uidEl.textContent = "-";
      }
    });

    setDebug("Hazır.");
  </script>
</body>
</html>