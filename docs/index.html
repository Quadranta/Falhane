<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Falhane Kullanıcı Paneli</title>
  <style>
    :root { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; }
    body { margin:0; background:#f4f6fb; color:#111; }
    .wrap { max-width: 760px; margin: 0 auto; padding: 18px; }
    h1 { font-size: 54px; letter-spacing: -1px; margin: 10px 0 18px; }
    .card { background:#fff; border-radius: 18px; padding: 18px; margin: 14px 0; box-shadow: 0 8px 24px rgba(0,0,0,.06); }
    .row { display:flex; gap: 12px; flex-wrap: wrap; align-items:center; }
    .btn {
      border:0; border-radius: 12px; padding: 14px 16px; font-weight: 700;
      cursor: pointer; width: 260px; max-width: 100%;
    }
    .btn-primary { background:#1f6fff; color:#fff; }
    .btn-dark { background:#0f172a; color:#fff; }
    .muted { color:#6b7280; font-size: 14px; }
    .pill { display:inline-block; padding: 8px 10px; border-radius: 999px; font-weight:700; font-size: 13px; }
    .ok { background:#e8fff1; color:#0a7a3b; border: 1px solid #bff2d0; }
    .warn { background:#fff7ed; color:#9a3412; border: 1px solid #fed7aa; }
    .err { background:#ffecec; color:#991b1b; border: 1px solid #fecaca; }
    .list { display:flex; flex-direction: column; gap: 12px; }
    .item { border: 1px solid #eef2ff; border-radius: 14px; padding: 14px; background:#fbfdff; }
    .item h3 { margin:0 0 6px; font-size: 16px; }
    .item .meta { font-size: 13px; color:#6b7280; margin-bottom: 10px; }
    pre { white-space: pre-wrap; word-break: break-word; margin:0; }
    .debug { background:#0b1220; color:#d1d5db; border-radius: 14px; padding: 14px; font-size: 13px; }
    .hr { height:1px; background:#eef2ff; margin: 12px 0; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Falhane Kullanıcı Paneli</h1>

    <div id="statusCard" class="card">
      <span id="statusPill" class="pill warn">Oturum kapalı. Google ile giriş yap.</span>
      <div class="hr"></div>

      <h2 style="margin:0 0 10px;">Giriş (Google)</h2>
      <div class="row">
        <button id="btnLogin" class="btn btn-primary">Google ile giriş</button>
        <button id="btnLogout" class="btn btn-dark">Çıkış</button>
      </div>

      <div style="margin-top:12px;">
        <div><b>Giriş yapan:</b> <span id="userEmail">-</span></div>
        <div><b>UID:</b> <span id="userUid">-</span></div>
        <div class="muted" style="margin-top:8px;">
          Not: Bu sayfa sadece <b>readings</b> koleksiyonundan <b>kendi</b> kayıtlarını gösterir.
        </div>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px;">Benim Fal Sonuçlarım (readings)</h2>
      <div class="row" style="justify-content: space-between;">
        <button id="btnRefresh" class="btn btn-primary" style="width: 100%;">Yenile</button>
      </div>
      <div class="muted" style="margin-top: 10px;">Toplam: <span id="count">0</span></div>
      <div class="hr"></div>
      <div id="list" class="list"></div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px;">Debug</h2>
      <div class="debug"><pre id="debug">Hazır.</pre></div>
    </div>
  </div>

  <!-- Firebase compat (kolay) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    // === Senin config (aynı bıraktım) ===
    const firebaseConfig = {
      apiKey: "AIzaSyBDTN_8sf9P7uwtnRqBTmlszcztb36g-XA",
      authDomain: "falhane-e3057.firebaseapp.com",
      projectId: "falhane-e3057",
      storageBucket: "falhane-e3057.firebasestorage.app",
      messagingSenderId: "117754512778",
      appId: "1:117754512778:web:52aee440472568bc6cb473",
      measurementId: "G-94TZ14VWPX"
    };

    // --- helpers ---
    const el = (id) => document.getElementById(id);
    const log = (s) => { el("debug").textContent += "\n" + s; };
    const setStatus = (type, text) => {
      const pill = el("statusPill");
      pill.classList.remove("ok","warn","err");
      pill.classList.add(type);
      pill.textContent = text;
    };

    // --- boot ---
    el("debug").textContent =
      "BOOT:\n" +
      "url=" + location.href + "\n" +
      "ua=" + navigator.userAgent + "\n";

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Provider
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({ prompt: "select_account" });

    // A) Persistence (kritik)
    (async () => {
      try {
        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        log("PERSISTENCE: LOCAL ok");
      } catch (e) {
        log("PERSISTENCE: hata => " + (e && e.code ? e.code : e));
      }
    })();

    // Auth state watcher (en kritik)
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        setStatus("warn", "Oturum kapalı. Google ile giriş yap.");
        el("userEmail").textContent = "-";
        el("userUid").textContent = "-";
        el("list").innerHTML = "";
        el("count").textContent = "0";
        log("AUTH STATE: null");
        return;
      }

      setStatus("ok", "Oturum açık");
      el("userEmail").textContent = user.email || "(email yok)";
      el("userUid").textContent = user.uid;
      log("AUTH STATE: user=" + (user.email || "-") + " uid=" + user.uid);

      await loadMyReadings();
    });

    // B) Login: Popup (öncelik) + Redirect fallback
    el("btnLogin").addEventListener("click", async () => {
      el("debug").textContent = "Hazır.\nBOOT:\nurl=" + location.href + "\nua=" + navigator.userAgent + "\n";
      log("LOGIN: tıklandı");

      try {
        // iOS Safari’de en stabil bu:
        const res = await auth.signInWithPopup(provider);
        log("LOGIN: popup ok => " + (res.user?.email || "-"));
      } catch (e) {
        const code = e?.code || "";
        log("LOGIN: popup hata => " + code);

        // Popup bloklanırsa redirect dene
        if (code.includes("popup-blocked") || code.includes("popup-closed-by-user") || code.includes("cancelled-popup-request")) {
          try {
            log("LOGIN: redirect fallback başlıyor...");
            await auth.signInWithRedirect(provider);
          } catch (e2) {
            log("LOGIN: redirect hata => " + (e2?.code || e2));
            setStatus("err", "Giriş HATA: " + (e2?.code || "redirect hata"));
          }
        } else {
          setStatus("err", "Giriş HATA: " + (code || "bilinmeyen"));
        }
      }
    });

    el("btnLogout").addEventListener("click", async () => {
      try {
        await auth.signOut();
        log("LOGOUT: ok");
      } catch (e) {
        log("LOGOUT: hata => " + (e?.code || e));
      }
    });

    el("btnRefresh").addEventListener("click", async () => {
      await loadMyReadings();
    });

    async function loadMyReadings() {
      const user = auth.currentUser;
      if (!user) {
        log("READINGS: user yok");
        return;
      }

      setStatus("ok", "Okuma yapılıyor...");
      el("list").innerHTML = "";
      el("count").textContent = "0";

      try {
        // Bu sorgu index isteyebilir:
        // readings where userId==uid orderBy createdAt desc
        const snap = await db.collection("readings")
          .where("userId", "==", user.uid)
          .orderBy("createdAt", "desc")
          .limit(50)
          .get();

        el("count").textContent = String(snap.size);

        if (snap.empty) {
          el("list").innerHTML = `<div class="muted">Kayıt yok.</div>`;
          setStatus("ok", "Okuma başarılı");
          log("READINGS: 0 kayıt");
          return;
        }

        const frag = document.createDocumentFragment();
        snap.forEach(doc => {
          const d = doc.data() || {};
          const createdAt = d.createdAt?.toDate ? d.createdAt.toDate().toISOString() : (d.createdAt || "-");
          const text = (d.text || d.result || d.reading || "").toString();

          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = `
            <h3>${doc.id}</h3>
            <div class="meta">createdAt: ${createdAt}</div>
            <div style="white-space:pre-wrap">${escapeHtml(text)}</div>
          `;
          frag.appendChild(div);
        });

        el("list").appendChild(frag);
        setStatus("ok", "Okuma başarılı");
        log("READINGS: ok => " + snap.size + " kayıt");
      } catch (e) {
        const msg = (e?.message || "").toString();
        setStatus("err", "Okuma HATA: " + (e?.code || "bilinmeyen"));
        log("READINGS: hata => " + (e?.code || e));
        log("READINGS: message => " + msg);

        // Index hatası olursa ekranda link verir zaten ama kısa yönlendirme:
        if (msg.includes("requires an index")) {
          log("INDEX: Firestore composite index lazım (userId + createdAt).");
        }
      }
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }
  </script>
</body>
</html>