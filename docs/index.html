<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Falhane Kullanıcı Paneli</title>
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#64748b; --b:#e5e7eb; --ok:#16a34a; --bad:#f59e0b; --pri:#2563eb; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
    .wrap{ max-width:820px; margin:0 auto; padding:18px; }
    h1{ font-size:44px; margin:8px 0 16px; }
    .card{ background:var(--card); border:1px solid var(--b); border-radius:16px; padding:14px; margin:12px 0; box-shadow:0 8px 24px rgba(15,23,42,.06); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .alert{ background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; padding:10px 12px; border-radius:12px; font-weight:800; }
    .btn{ border:0; border-radius:12px; padding:10px 14px; font-weight:900; cursor:pointer; }
    .btn.blue{ background:var(--pri); color:#fff; }
    .btn.gray{ background:#111827; color:#fff; }
    .btn.ok{ background:var(--ok); color:#fff; }
    .muted{ color:var(--muted); }
    input, select{ width:100%; padding:12px; border-radius:12px; border:1px solid var(--b); font-size:16px; }
    label{ display:block; font-weight:900; margin:10px 0 8px; }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .box{ border:1px dashed #cbd5e1; border-radius:14px; padding:12px; background:#f8fafc; }
    .smallbtn{ border:1px solid var(--b); border-radius:12px; padding:10px 12px; font-weight:900; cursor:pointer; background:#fff; }
    .thumbs{ display:flex; gap:10px; margin-top:10px; }
    .thumb{ width:110px; height:150px; border-radius:14px; border:1px dashed #cbd5e1; background:#fff; object-fit:cover; }
    .debug{ background:#0b1220; color:#d1d5db; border-radius:16px; padding:12px; white-space:pre-wrap; font-family:ui-monospace,SFMono-Regular,Menlo,monospace; }
    .disabled{ opacity:.45; pointer-events:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Falhane Kullanıcı Paneli</h1>

    <div id="alert" class="alert">Oturum kapalı. Google ile giriş yap.</div>

    <div class="card">
      <h2 style="margin:0 0 10px">Giriş (Google)</h2>
      <div class="row">
        <button id="btnGoogle" class="btn blue" type="button">Google ile giriş</button>
        <button id="btnLogout" class="btn gray" type="button" style="display:none">Çıkış</button>
      </div>

      <div class="muted" style="margin-top:10px">
        Giriş yapan: <b id="who">-</b><br/>
        UID: <b id="uid">-</b><br/>
        Not: Bu sayfa upload oluşturur. Admin paneli “uploads” içinden onaylayınca “readings”e taşır.
      </div>
    </div>

    <div class="card" id="formCard">
      <h2 style="margin:0 0 6px">Fal Başvurusu (2 Foto)</h2>
      <div class="muted" style="margin:0 0 12px">Bu formu göndermek için giriş yapman gerekiyor.</div>

      <label>Ad</label>
      <input id="name" placeholder="Adın" />

      <label>Yaş</label>
      <input id="age" type="number" inputmode="numeric" placeholder="Örn: 26" />

      <label>Burç</label>
      <select id="sign">
        <option value="">Seç</option>
        <option>Koç</option><option>Boğa</option><option>İkizler</option><option>Yengeç</option>
        <option>Aslan</option><option>Başak</option><option>Terazi</option><option>Akrep</option>
        <option>Yay</option><option>Oğlak</option><option>Kova</option><option>Balık</option>
      </select>

      <div class="grid2" style="margin-top:12px">
        <div class="box">
          <div style="font-weight:900;margin-bottom:8px">Foto 1</div>
          <input id="file1" type="file" accept="image/*" style="display:none" />
          <input id="cam1" type="file" accept="image/*" capture="environment" style="display:none" />
          <div class="row">
            <button class="smallbtn" id="pick1" type="button">Galeriden seç</button>
            <button class="smallbtn" id="take1" type="button">Kamera ile çek</button>
          </div>
        </div>

        <div class="box">
          <div style="font-weight:900;margin-bottom:8px">Foto 2</div>
          <input id="file2" type="file" accept="image/*" style="display:none" />
          <input id="cam2" type="file" accept="image/*" capture="environment" style="display:none" />
          <div class="row">
            <button class="smallbtn" id="pick2" type="button">Galeriden seç</button>
            <button class="smallbtn" id="take2" type="button">Kamera ile çek</button>
          </div>
        </div>
      </div>

      <div class="thumbs">
        <img id="prev1" class="thumb" alt="prev1" />
        <img id="prev2" class="thumb" alt="prev2" />
      </div>

      <div class="row" style="margin-top:14px">
        <button id="btnSend" class="btn ok" type="button" style="flex:1">Başvuruyu Gönder</button>
      </div>

      <div class="muted" style="margin-top:10px">
        İpucu: “Kamera ile çek” telefonda kamerayı açar. “Galeriden seç” galeriden seçmek içindir.
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px">Debug</h2>
      <div id="dbg" class="debug">Hazır.</div>
    </div>
  </div>

  <script type="module">
    // ===== Firebase Config =====
    const firebaseConfig = {
      apiKey: "AIzaSyBDTN_8sf9P7uwtnRqBTmlszcztb36g-XA",
      authDomain: "falhane-e3057.firebaseapp.com",
      projectId: "falhane-e3057",
      storageBucket: "falhane-e3057.firebasestorage.app",
      messagingSenderId: "117754512778",
      appId: "1:117754512778:web:52aee440472568bc6cb473",
      measurementId: "G-94TZ14VWPX"
    };

    // ===== Imports =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      signInWithRedirect, getRedirectResult, signOut,
      GoogleAuthProvider,
      setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const st = getStorage(app);

    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: "select_account" });

    const $ = (id) => document.getElementById(id);
    const dbg = (s) => $("dbg").textContent = (typeof s === "string" ? s : JSON.stringify(s,null,2));

    // ===== iOS Safari için en kritik satır: persistence =====
    try {
      await setPersistence(auth, browserLocalPersistence);
      dbg("BOOT: persistence=browserLocalPersistence\n");
    } catch (e) {
      dbg("BOOT: persistence set ERROR\n" + (e.code || "") + " " + (e.message || e));
    }

    // ===== Redirect result =====
    try {
      const r = await getRedirectResult(auth);
      dbg($("dbg").textContent + "\nREDIRECT RESULT: " + (r?.user?.email || "boş (normal olabilir)"));
    } catch (e) {
      dbg($("dbg").textContent + "\nREDIRECT ERROR: " + (e.code || "") + " " + (e.message || e));
    }

    // ===== UI =====
    const alert = $("alert");
    const who = $("who");
    const uid = $("uid");
    const btnGoogle = $("btnGoogle");
    const btnLogout = $("btnLogout");
    const formCard = $("formCard");
    const btnSend = $("btnSend");

    const file1 = $("file1"), file2 = $("file2"), cam1 = $("cam1"), cam2 = $("cam2");
    const prev1 = $("prev1"), prev2 = $("prev2");
    let f1 = null, f2 = null;

    $("pick1").onclick = () => file1.click();
    $("pick2").onclick = () => file2.click();
    $("take1").onclick = () => cam1.click();
    $("take2").onclick = () => cam2.click();

    function setPreview(imgEl, file){
      if (!file) { imgEl.removeAttribute("src"); return; }
      const url = URL.createObjectURL(file);
      imgEl.src = url;
    }

    file1.onchange = (e)=>{ f1 = e.target.files?.[0] || null; setPreview(prev1, f1); };
    file2.onchange = (e)=>{ f2 = e.target.files?.[0] || null; setPreview(prev2, f2); };
    cam1.onchange  = (e)=>{ f1 = e.target.files?.[0] || null; setPreview(prev1, f1); };
    cam2.onchange  = (e)=>{ f2 = e.target.files?.[0] || null; setPreview(prev2, f2); };

    btnGoogle.onclick = async () => {
      try {
        dbg($("dbg").textContent + "\nLOGIN: redirect başlıyor...");
        await signInWithRedirect(auth, provider);
      } catch (e) {
        dbg($("dbg").textContent + "\nLOGIN ERROR: " + (e.code || "") + " " + (e.message || e));
      }
    };

    btnLogout.onclick = async () => {
      await signOut(auth);
    };

    function setSignedIn(user){
      alert.textContent = "Giriş yapıldı.";
      who.textContent = user.email || "-";
      uid.textContent = user.uid || "-";
      btnGoogle.style.display = "none";
      btnLogout.style.display = "inline-block";
      formCard.classList.remove("disabled");
      btnSend.classList.remove("disabled");
    }

    function setSignedOut(){
      alert.textContent = "Oturum kapalı. Google ile giriş yap.";
      who.textContent = "-";
      uid.textContent = "-";
      btnGoogle.style.display = "inline-block";
      btnLogout.style.display = "none";
      formCard.classList.add("disabled");
      btnSend.classList.add("disabled");
    }

    onAuthStateChanged(auth, (user) => {
      dbg($("dbg").textContent + "\nAUTH STATE: " + (user ? "signed in" : "signed out"));
      if (user) setSignedIn(user); else setSignedOut();
    });

    async function uploadOne(userId, which, file){
      const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
      const id = `${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
      const path = `uploads/${userId}/${id}/${which}.${ext}`;
      const r = ref(st, path);
      await uploadBytes(r, file);
      return await getDownloadURL(r);
    }

    btnSend.onclick = async () => {
      try {
        const user = auth.currentUser;
        if (!user) { alert.textContent = "Önce Google ile giriş yap."; return; }

        const name = $("name").value.trim();
        const age  = Number($("age").value);
        const sign = $("sign").value;

        if (!name) { alert.textContent = "Ad zorunlu."; return; }
        if (!age || age < 1) { alert.textContent = "Yaş geçersiz."; return; }
        if (!sign) { alert.textContent = "Burç seç."; return; }
        if (!f1 || !f2) { alert.textContent = "2 foto zorunlu."; return; }

        alert.textContent = "Yükleniyor...";

        const photo1Url = await uploadOne(user.uid, "photo1", f1);
        const photo2Url = await uploadOne(user.uid, "photo2", f2);

        await addDoc(collection(db, "uploads"), {
          status: "pending",
          userId: user.uid,
          email: user.email || null,
          name, age, sign,
          photo1Url, photo2Url,
          createdAt: serverTimestamp()
        });

        alert.textContent = "Başvuru gönderildi (pending). Admin onaylayınca reading oluşacak.";
        dbg($("dbg").textContent + "\nUPLOAD: OK");

      } catch (e) {
        alert.textContent = "Hata: " + (e.code || e.message || e);
        dbg($("dbg").textContent + "\nSEND ERROR: " + (e.code || "") + " " + (e.message || e));
      }
    };
  </script>
</body>
</html>