<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Falhane Kullanıcı Paneli</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#f6f7fb; margin:0; padding:24px;}
    h1{font-size:44px; margin:0 0 18px;}
    .card{background:#fff; border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.08); margin:16px 0;}
    .row{display:flex; gap:12px; flex-wrap:wrap;}
    button{border:0; border-radius:12px; padding:14px 16px; font-size:16px; cursor:pointer;}
    .primary{background:#2563eb; color:#fff; flex:1;}
    .dark{background:#0f172a; color:#fff; flex:1;}
    .muted{color:#64748b; font-size:14px; margin-top:8px;}
    .status{padding:12px 14px; border-radius:12px; margin:14px 0; font-weight:600;}
    .ok{background:#e9f9ef; border:1px solid #b7f0c8; color:#14532d;}
    .err{background:#ffecec; border:1px solid #ffb5b5; color:#7f1d1d; white-space:pre-wrap;}
    .list{display:flex; flex-direction:column; gap:12px;}
    .item{border:1px solid #e5e7eb; border-radius:14px; padding:14px;}
    .badge{display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700; background:#eef2ff; color:#3730a3;}
    pre{background:#0b1220; color:#e5e7eb; padding:14px; border-radius:12px; overflow:auto; font-size:12px;}
    a{color:#2563eb; word-break:break-all;}
  </style>
</head>
<body>
  <h1>Falhane Kullanıcı Paneli</h1>

  <div id="statusBox" class="status ok">Hazır.</div>

  <div class="card">
    <h2>Giriş (Google)</h2>
    <div class="row">
      <button id="btnLogin" class="primary">Google ile giriş</button>
      <button id="btnLogout" class="dark">Çıkış</button>
    </div>
    <div class="muted">
      Giriş yapan: <b id="who">-</b><br/>
      UID: <b id="uid">-</b><br/>
      Not: Bu sayfa sadece <b>readings</b> koleksiyonundan kendi kayıtlarını gösterir.
    </div>
  </div>

  <div class="card">
    <h2>Benim Fal Sonuçlarım (readings)</h2>
    <div class="row">
      <button id="btnRefresh" class="primary">Yenile</button>
    </div>
    <div class="muted">Toplam: <b id="count">0</b></div>
    <div id="list" class="list"></div>
  </div>

  <div class="card">
    <h2>Debug</h2>
    <pre id="debug">-</pre>
  </div>

  <script type="module">
    // Firebase (modular v10)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut,
      GoogleAuthProvider,
      signInWithRedirect,
      getRedirectResult,
      setPersistence,
      browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    import {
      getFirestore,
      collection,
      query,
      where,
      orderBy,
      limit,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // === SENİN CONFIG (aynen) ===
    const firebaseConfig = {
      apiKey: "AIzaSyBDTN_8sf9P7uwtnRqBTmlszcztb36g-XA",
      authDomain: "falhane-e3057.firebaseapp.com",
      projectId: "falhane-e3057",
      storageBucket: "falhane-e3057.firebasestorage.app",
      messagingSenderId: "117754512778",
      appId: "1:117754512778:web:52aee440472568bc6cb473",
      measurementId: "G-94TZ14VWPX"
    };

    // UI helpers
    const el = (id)=>document.getElementById(id);
    const log = (msg)=>{ el("debug").textContent = msg; };
    const setStatusOk = (msg)=>{ el("statusBox").className="status ok"; el("statusBox").textContent = msg; };
    const setStatusErr = (msg)=>{ el("statusBox").className="status err"; el("statusBox").textContent = msg; };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // iOS/Safari için persistence net olsun
    try {
      await setPersistence(auth, browserLocalPersistence);
    } catch (e) {
      // Private mod bazı durumlarda kısıtlayabilir; yine de devam.
      log("Persistence uyarı: " + (e?.message || e));
    }

    auth.languageCode = "tr";
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({
      prompt: "select_account"  // hesap seçtir, aynı hesapta takılmayı azaltır
    });

    async function refreshReadings() {
      const user = auth.currentUser;
      if (!user) {
        el("count").textContent = "0";
        el("list").innerHTML = "";
        setStatusOk("Oturum kapalı. Google ile giriş yap.");
        return;
      }

      // readings: sadece kendi kayıtlarını çek
      // Bu query index ister: userId ASC + createdAt DESC
      const q = query(
        collection(db, "readings"),
        where("userId", "==", user.uid),
        orderBy("createdAt", "desc"),
        limit(50)
      );

      const snap = await getDocs(q);
      el("count").textContent = String(snap.size);

      const items = [];
      snap.forEach(doc => {
        const d = doc.data() || {};
        const text = (d.text ?? "").toString();
        const createdAt = d.createdAt?.toDate ? d.createdAt.toDate().toISOString() : (d.createdAt ?? "-");
        const status = d.status ?? "approved";
        items.push(`
          <div class="item">
            <div><b>${doc.id}</b> <span class="badge">${status}</span></div>
            <div class="muted">createdAt: ${createdAt}</div>
            <div style="margin-top:8px; white-space:pre-wrap;">${escapeHtml(text)}</div>
          </div>
        `);
      });

      el("list").innerHTML = items.join("") || `<div class="muted">Kayıt yok.</div>`;
      setStatusOk("Okuma başarılı");
    }

    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g, (c)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    // Redirect dönüşünü yakala (sayfa açılınca çalışır)
    try {
      const res = await getRedirectResult(auth);
      if (res?.user) {
        setStatusOk("Giriş başarılı (redirect).");
      } else {
        log("getRedirectResult: sonuç yok (normal).");
      }
    } catch (e) {
      setStatusErr("Redirect sonuç hatası:\n" + (e?.message || e));
      log(JSON.stringify(e, null, 2));
    }

    // Oturum değişince UI güncelle
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        el("who").textContent = user.email || "(email yok)";
        el("uid").textContent = user.uid;
        setStatusOk("Oturum açık.");
        await refreshReadings();
      } else {
        el("who").textContent = "-";
        el("uid").textContent = "-";
        setStatusOk("Oturum kapalı. Google ile giriş yap.");
        el("count").textContent = "0";
        el("list").innerHTML = "";
      }
    });

    // Buttons
    el("btnLogin").addEventListener("click", async () => {
      try {
        setStatusOk("Google yönlendirmesi başlatılıyor...");
        await signInWithRedirect(auth, provider);
        // buradan sonra sayfa Google'a gider
      } catch (e) {
        setStatusErr("Giriş başlatma hatası:\n" + (e?.message || e));
        log(JSON.stringify(e, null, 2));
      }
    });

    el("btnLogout").addEventListener("click", async () => {
      try {
        await signOut(auth);
        setStatusOk("Çıkış yapıldı.");
      } catch (e) {
        setStatusErr("Çıkış hatası:\n" + (e?.message || e));
      }
    });

    el("btnRefresh").addEventListener("click", async () => {
      try {
        await refreshReadings();
      } catch (e) {
        setStatusErr("Okuma hatası:\n" + (e?.message || e));
        log(JSON.stringify(e, null, 2));
      }
    });
  </script>
</body>
</html>