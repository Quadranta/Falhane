<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Falhane Kullanıcı Paneli</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#f3f6fb;color:#111}
    .wrap{max-width:920px;margin:0 auto;padding:22px}
    h1{font-size:44px;line-height:1.05;margin:12px 0 16px}
    .card{background:#fff;border:1px solid #e6e8ef;border-radius:18px;padding:16px 16px 18px;margin:14px 0;box-shadow:0 6px 24px rgba(12,19,33,.06)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{border:0;border-radius:14px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btnPrimary{background:#2563eb;color:#fff}
    .btnGhost{background:#e9eefb;color:#0f172a}
    .btnDanger{background:#111827;color:#fff}
    .btnOk{background:#16a34a;color:#fff}
    .muted{color:#64748b}
    .pill{display:inline-block;background:#eef2ff;color:#1e3a8a;padding:8px 10px;border-radius:999px;font-weight:800}
    .warn{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;padding:10px 12px;border-radius:14px;font-weight:700}
    label{display:block;font-weight:800;margin:12px 0 6px}
    input,select,textarea{width:100%;padding:12px;border-radius:14px;border:1px solid #e5e7eb;font-size:16px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.grid2{grid-template-columns:1fr}}
    .photoBox{border:2px dashed #d7dce8;border-radius:16px;padding:12px;background:#f8fafc}
    .previewGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
    .preview{aspect-ratio:3/4;border-radius:16px;border:2px dashed #d7dce8;display:flex;align-items:center;justify-content:center;color:#64748b;font-weight:800;background:#fff;overflow:hidden}
    .preview img{width:100%;height:100%;object-fit:cover}
    .hr{height:1px;background:#eef2f7;margin:14px 0}
    .listItem{border:1px solid #e6e8ef;border-radius:18px;padding:14px;margin:10px 0;background:#fff}
    .small{font-size:13px}
    .debug{white-space:pre-wrap;background:#0b1220;color:#e5e7eb;border-radius:16px;padding:12px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Falhane Kullanıcı<br/>Paneli</h1>

    <div id="banner" class="warn" style="display:none"></div>

    <div class="card">
      <div class="row">
        <div style="min-width:220px">
          <div class="pill" id="authPill">Oturum kapalı</div>
          <div class="small muted" style="margin-top:8px">
            Giriş yapan: <b id="userEmail">-</b><br/>
            UID: <b id="userUid">-</b>
          </div>
        </div>
        <div class="right row">
          <button class="btn btnPrimary" id="btnGoogle">Google ile giriş</button>
          <button class="btn btnGhost" id="btnApple" title="Apple sonra aktif edilecek">Apple ile giriş (sonra)</button>
          <button class="btn btnDanger" id="btnLogout">Çıkış</button>
        </div>
      </div>
      <div class="muted small" style="margin-top:10px">
        Not: Apple henüz aktif değil; buton sadece uyarı verir. Google çalışır.
      </div>
    </div>

    <div class="card" id="formCard" style="display:none">
      <h2 style="margin:0 0 10px">Fal Başvurusu (2 Foto)</h2>

      <label>Ad</label>
      <input id="inpName" placeholder="Adın" />

      <label>Yaş</label>
      <input id="inpAge" type="number" placeholder="Örn: 26" />

      <label>Burç</label>
      <select id="selSign">
        <option value="">Seç</option>
        <option>Koç</option><option>Boğa</option><option>İkizler</option><option>Yengeç</option>
        <option>Aslan</option><option>Başak</option><option>Terazi</option><option>Akrep</option>
        <option>Yay</option><option>Oğlak</option><option>Kova</option><option>Balık</option>
      </select>

      <div class="hr"></div>

      <div class="grid2">
        <div class="photoBox">
          <b>Foto 1</b>
          <div class="row" style="margin-top:10px">
            <input id="file1" type="file" accept="image/*" style="flex:1" />
            <input id="cam1" type="file" accept="image/*" capture="environment" style="display:none" />
            <button class="btn btnGhost" id="btnCam1">Kamera ile çek</button>
          </div>
        </div>

        <div class="photoBox">
          <b>Foto 2</b>
          <div class="row" style="margin-top:10px">
            <input id="file2" type="file" accept="image/*" style="flex:1" />
            <input id="cam2" type="file" accept="image/*" capture="environment" style="display:none" />
            <button class="btn btnGhost" id="btnCam2">Kamera ile çek</button>
          </div>
        </div>
      </div>

      <div class="previewGrid">
        <div class="preview" id="prev1">Önizleme 1</div>
        <div class="preview" id="prev2">Önizleme 2</div>
      </div>

      <div class="row" style="margin-top:14px">
        <button class="btn btnOk" id="btnSend" style="flex:1">Falımı Gönder</button>
        <button class="btn btnGhost" id="btnReloadMine">Geçmişi Yenile</button>
      </div>

      <div class="muted small" style="margin-top:10px">
        İpucu: “Kamera ile çek” telefonda kamerayı açar. “Dosya seç” galeriden seçmek içindir.
      </div>
    </div>

    <div class="card" id="historyCard" style="display:none">
      <div class="row">
        <h2 style="margin:0">Geçmiş Fallarım</h2>
        <button class="btn btnGhost right" id="btnReloadMine2">Yenile</button>
      </div>
      <div class="muted" id="mineCount" style="margin-top:6px"></div>
      <div id="mineList"></div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px">Debug</h2>
      <div class="debug" id="debugBox">Hazır.</div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signOut,
    GoogleAuthProvider, signInWithPopup,
    setPersistence, browserLocalPersistence
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, query, where, orderBy, limit, getDocs, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import {
    getStorage, ref as sRef, uploadBytes, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

  // === FIREBASE CONFIG (SENİN VERDİĞİN) ===
  const firebaseConfig = {
    apiKey: "AIzaSyBDTN_8sf9P7uwtnRqBTmlszcztb36g-XA",
    authDomain: "falhane-e3057.firebaseapp.com",
    projectId: "falhane-e3057",
    storageBucket: "falhane-e3057.firebasestorage.app",
    messagingSenderId: "117754512778",
    appId: "1:117754512778:web:52aee440472568bc6cb473",
    measurementId: "G-94TZ14VWPX"
  };

  // === UI HELPERS ===
  const $ = (id) => document.getElementById(id);
  const log = (s) => $("debugBox").textContent = String(s);
  const banner = (s) => { $("banner").style.display = s ? "block" : "none"; $("banner").textContent = s || ""; };

  function pickRandomPendingText() {
    const arr = [
      "Falcı fincanı inceliyor. 5 dakika içinde hazır.",
      "Enerjini alıyorum… Falın birazdan çıkacak.",
      "Fincanda hareket var. Falın hazırlanıyor.",
      "Kahve telvesi konuşuyor… Çok az kaldı.",
      "Falın sıraya alındı. Birkaç dakika içinde sende."
    ];
    return arr[Math.floor(Math.random() * arr.length)];
  }

  function fmtDate(ts) {
    try {
      if (!ts) return "-";
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      const pad = (n)=>String(n).padStart(2,"0");
      return `${pad(d.getDate())}-${pad(d.getMonth()+1)}-${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    } catch { return "-"; }
  }

  function setPreview(box, file) {
    if (!file) { box.textContent = box.id === "prev1" ? "Önizleme 1" : "Önizleme 2"; return; }
    const url = URL.createObjectURL(file);
    box.innerHTML = `<img src="${url}" alt="preview"/>`;
  }

  // === INIT ===
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  log("BOOT: start\nBOOT: persistence=browserLocalPersistence");
  await setPersistence(auth, browserLocalPersistence);

  // === AUTH UI ===
  $("btnApple").onclick = () => alert("Apple girişi daha aktif değil. Sonra yapacağız.");
  $("btnLogout").onclick = async () => { await signOut(auth); };

  $("btnGoogle").onclick = async () => {
    try {
      banner("");
      const provider = new GoogleAuthProvider();
      provider.setCustomParameters({ prompt: "select_account" });
      log($("debugBox").textContent + "\nLOGIN: popup deneniyor (iOS için daha stabil)...");
      await signInWithPopup(auth, provider);
      log($("debugBox").textContent + "\nLOGIN: popup OK");
    } catch (e) {
      log($("debugBox").textContent + "\nLOGIN ERROR: " + (e?.code || e?.message || e));
      banner("Google giriş başarısız: " + (e?.code || e?.message || e));
    }
  };

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      $("authPill").textContent = "Oturum açık";
      $("authPill").style.background = "#dcfce7";
      $("authPill").style.color = "#14532d";
      $("userEmail").textContent = user.email || "-";
      $("userUid").textContent = user.uid || "-";
      $("formCard").style.display = "block";
      $("historyCard").style.display = "block";
      banner("");
      await loadMyHistory();
    } else {
      $("authPill").textContent = "Oturum kapalı";
      $("authPill").style.background = "#fee2e2";
      $("authPill").style.color = "#7f1d1d";
      $("userEmail").textContent = "-";
      $("userUid").textContent = "-";
      $("formCard").style.display = "none";
      $("historyCard").style.display = "none";
      banner("Oturum kapalı. Google ile giriş yap.");
    }
  });

  // === CAMERA BUTTONS ===
  $("btnCam1").onclick = () => $("cam1").click();
  $("btnCam2").onclick = () => $("cam2").click();

  let f1 = null, f2 = null;

  $("file1").onchange = (e)=>{ f1 = e.target.files?.[0] || null; setPreview($("prev1"), f1); };
  $("file2").onchange = (e)=>{ f2 = e.target.files?.[0] || null; setPreview($("prev2"), f2); };
  $("cam1").onchange  = (e)=>{ f1 = e.target.files?.[0] || null; setPreview($("prev1"), f1); };
  $("cam2").onchange  = (e)=>{ f2 = e.target.files?.[0] || null; setPreview($("prev2"), f2); };

  // === SEND ===
  $("btnSend").onclick = async () => {
    try {
      banner("");
      const user = auth.currentUser;
      if (!user) throw new Error("Oturum yok.");
      const name = $("inpName").value.trim();
      const age = Number($("inpAge").value);
      const sign = $("selSign").value.trim();

      if (!name) throw new Error("Ad boş.");
      if (!age || Number.isNaN(age)) throw new Error("Yaş sayı olmalı.");
      if (!sign) throw new Error("Burç seç.");

      if (!f1 || !f2) throw new Error("2 foto zorunlu.");

      $("btnSend").disabled = true;
      $("btnSend").textContent = "Yükleniyor...";

      const base = `uploads/${user.uid}/${Date.now()}`;
      const r1 = sRef(storage, `${base}/photo1.jpg`);
      const r2 = sRef(storage, `${base}/photo2.jpg`);

      await uploadBytes(r1, f1);
      await uploadBytes(r2, f2);

      const url1 = await getDownloadURL(r1);
      const url2 = await getDownloadURL(r2);

      // uploads doc
      await addDoc(collection(db, "uploads"), {
        userId: user.uid,
        email: user.email || null,
        name,
        age,
        sign,
        photo1: url1,
        photo2: url2,
        status: "pending",
        statusText: pickRandomPendingText(),
        comment: "",
        createdAt: serverTimestamp(),
        approvedAt: null,
        approvedBy: null
      });

      banner("Falın sıraya alındı. İnceleme başladı.");
      $("btnSend").textContent = "Falımı Gönder";
      $("btnSend").disabled = false;
      await loadMyHistory();
    } catch (e) {
      $("btnSend").textContent = "Falımı Gönder";
      $("btnSend").disabled = false;

      const msg = (e?.message || e?.code || String(e));
      banner("Gönderim hatası: " + msg);
      log($("debugBox").textContent + "\nSEND ERROR: " + msg);

      // Index hatasını kullanıcıya net göster
      if (String(msg).includes("requires an index") || String(msg).includes("FAILED_PRECONDITION")) {
        banner("Firestore index lazım. Admin tarafında verilen linkten Create Index yapmalısın.");
      }
    }
  };

  $("btnReloadMine").onclick = loadMyHistory;
  $("btnReloadMine2").onclick = loadMyHistory;

  async function loadMyHistory() {
    const user = auth.currentUser;
    if (!user) return;

    try {
      const q = query(
        collection(db, "uploads"),
        where("userId", "==", user.uid),
        orderBy("createdAt", "desc"),
        limit(50)
      );
      const snap = await getDocs(q);
      const items = [];
      snap.forEach(d => items.push({ id: d.id, ...d.data() }));

      $("mineCount").textContent = `${items.length} kayıt bulundu.`;
      $("mineList").innerHTML = items.map(renderMine).join("");
    } catch (e) {
      const msg = (e?.message || e?.code || String(e));
      log($("debugBox").textContent + "\nHISTORY ERROR: " + msg);
      banner("Geçmiş yükleme hatası: " + msg);
    }
  }

  function renderMine(x) {
    const status = x.status || "-";
    const st = x.statusText || "";
    const comment = x.comment || "";
    const created = fmtDate(x.createdAt);

    const hasComment = comment.trim().length > 0;
    const commentHtml = hasComment
      ? `<div class="hr"></div><b>Fal Yorumu</b><div style="margin-top:6px;white-space:pre-wrap">${escapeHtml(comment)}</div>`
      : "";

    return `
      <div class="listItem">
        <div style="font-size:22px;font-weight:900">${escapeHtml(x.name || "-")}</div>
        <div class="row" style="margin-top:8px">
          <span class="pill">Yaş: ${escapeHtml(String(x.age ?? "-"))}</span>
          <span class="pill">Burç: ${escapeHtml(String(x.sign ?? "-"))}</span>
          <span class="pill">Tarih: ${escapeHtml(created)}</span>
          <span class="pill">Durum: ${escapeHtml(status)}</span>
        </div>
        <div class="muted" style="margin-top:10px">${escapeHtml(st)}</div>
        ${commentHtml}
        <div class="row" style="margin-top:10px">
          <a class="btn btnGhost" href="${x.photo1 || "#"}" target="_blank" rel="noreferrer">Foto1</a>
          <a class="btn btnGhost" href="${x.photo2 || "#"}" target="_blank" rel="noreferrer">Foto2</a>
        </div>
      </div>
    `;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

</script>
</body>
</html>