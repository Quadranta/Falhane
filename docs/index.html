<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Falhane Kullanıcı Paneli</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#f3f6fb;color:#111}
    .wrap{max-width:900px;margin:24px auto;padding:0 16px}
    h1{font-size:44px;letter-spacing:-1px;margin:8px 0 18px}
    .card{background:#fff;border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:16px;margin:12px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .muted{color:#6b7280}
    .hide{display:none!important}

    button{border:0;border-radius:12px;padding:12px 14px;font-weight:800;cursor:pointer}
    .btnG{background:#1f6feb;color:#fff}
    .btnA{background:#111827;color:#fff}
    .btnOut{background:#6b7280;color:#fff}
    .btnSend{background:#16a34a;color:#fff;width:100%;padding:14px 16px;border-radius:14px;font-size:16px}

    input,select{width:100%;padding:12px 12px;border:1px solid #e5e7eb;border-radius:12px;font-size:16px}
    label{display:block;font-weight:700;margin:10px 0 6px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:720px){.grid2{grid-template-columns:1fr}}

    .photoBox{border:2px dashed #e5e7eb;border-radius:14px;padding:12px}
    .photoBtns{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .btnSmall{padding:10px 12px;border-radius:12px;font-weight:800;background:#eef2ff}
    .previewRow{display:flex;gap:12px;margin-top:10px}
    .prev{width:140px;height:180px;border:2px dashed #e5e7eb;border-radius:14px;display:flex;align-items:center;justify-content:center;color:#9ca3af;overflow:hidden}
    .prev img{width:100%;height:100%;object-fit:cover}
    pre{white-space:pre-wrap;background:#0b1220;color:#e5e7eb;border-radius:14px;padding:12px;overflow:auto}
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Falhane Kullanıcı Paneli</h1>

    <!-- LOGIN CARD -->
    <div id="loginCard" class="card">
      <div id="warn" class="muted" style="font-weight:800;margin-bottom:10px">
        Oturum kapalı. Giriş yap.
      </div>

      <div class="row">
        <button id="btnGoogle" class="btnG">Google ile giriş</button>
        <button id="btnApple" class="btnA">Apple ile giriş</button>
        <button id="btnLogout" class="btnOut hide">Çıkış</button>
      </div>

      <div class="muted" style="margin-top:10px">
        Giriş yapan: <span id="whoEmail">-</span> &nbsp; | &nbsp; UID: <span id="whoUid">-</span>
      </div>
    </div>

    <!-- FORM CARD (GİRİŞ YOKSA GÖRÜNMEZ) -->
    <div id="formCard" class="card hide">
      <h2 style="margin:0 0 8px">Fal Başvurusu (2 Foto)</h2>
      <div class="muted" style="margin-bottom:12px">Formu göndermek için giriş yapılmış olmalı.</div>

      <label>Ad</label>
      <input id="name" placeholder="Adın" />

      <label>Yaş</label>
      <input id="age" type="number" placeholder="Örn: 26" />

      <label>Burç</label>
      <select id="sign">
        <option value="">Seç</option>
        <option>Koç</option><option>Boğa</option><option>İkizler</option><option>Yengeç</option>
        <option>Aslan</option><option>Başak</option><option>Terazi</option><option>Akrep</option>
        <option>Yay</option><option>Oğlak</option><option>Kova</option><option>Balık</option>
      </select>

      <div class="grid2" style="margin-top:12px">
        <div class="photoBox">
          <div style="font-weight:900">Foto 1</div>
          <div class="photoBtns">
            <input id="file1" type="file" accept="image/*" class="hide" />
            <input id="cam1" type="file" accept="image/*" capture="environment" class="hide" />
            <button id="pick1" class="btnSmall">Galeriden seç</button>
            <button id="take1" class="btnSmall">Kamera ile çek</button>
          </div>
        </div>

        <div class="photoBox">
          <div style="font-weight:900">Foto 2</div>
          <div class="photoBtns">
            <input id="file2" type="file" accept="image/*" class="hide" />
            <input id="cam2" type="file" accept="image/*" capture="environment" class="hide" />
            <button id="pick2" class="btnSmall">Galeriden seç</button>
            <button id="take2" class="btnSmall">Kamera ile çek</button>
          </div>
        </div>
      </div>

      <div class="previewRow">
        <div id="prev1" class="prev">Önizleme 1</div>
        <div id="prev2" class="prev">Önizleme 2</div>
      </div>

      <div style="margin-top:14px">
        <button id="btnSend" class="btnSend">Başvuruyu Gönder</button>
      </div>

      <div class="muted" style="margin-top:10px">
        İpucu: “Kamera ile çek” telefonda kamerayı açar. “Galeriden seç” galeriden seçmek içindir.
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px">Debug</h2>
      <pre id="debug">BOOT: loading...</pre>
    </div>

  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth,
    GoogleAuthProvider,
    OAuthProvider,
    signInWithPopup,
    signInWithRedirect,
    getRedirectResult,
    onAuthStateChanged,
    setPersistence,
    browserLocalPersistence,
    browserSessionPersistence,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  // NOT: Gönderme kısmını senin mevcut upload koduna bağlayacaksın.
  // Burada sadece login + form gizleme gösterme var.

  const firebaseConfig = {
    apiKey: "AIzaSyBDTN_8sf9P7uwtnRqBTmlszcztb36g-XA",
    authDomain: "falhane-e3057.firebaseapp.com",
    projectId: "falhane-e3057",
    storageBucket: "falhane-e3057.firebasestorage.app",
    messagingSenderId: "117754512778",
    appId: "1:117754512778:web:52aee440472568bc6cb473",
    measurementId: "G-94TZ14VWPX"
  };

  const $ = (id) => document.getElementById(id);
  const debug = (msg) => $("debug").textContent += "\n" + msg;

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  const googleProvider = new GoogleAuthProvider();
  const appleProvider = new OAuthProvider("apple.com"); // Apple

  async function ensurePersistence(){
    try {
      await setPersistence(auth, browserLocalPersistence);
      debug("BOOT: persistence=browserLocalPersistence");
    } catch(e){
      debug("BOOT: local persistence FAIL -> session. " + (e?.code || e));
      await setPersistence(auth, browserSessionPersistence);
      debug("BOOT: persistence=browserSessionPersistence");
    }
  }

  function renderSignedOut(){
    $("whoEmail").textContent = "-";
    $("whoUid").textContent = "-";
    $("btnLogout").classList.add("hide");
    $("btnGoogle").classList.remove("hide");
    $("btnApple").classList.remove("hide");

    // GİRİŞ YOKSA FORM GÖRÜNMEZ
    $("formCard").classList.add("hide");
    $("warn").textContent = "Oturum kapalı. Giriş yap.";
  }

  function renderSignedIn(user){
    $("whoEmail").textContent = user.email || "-";
    $("whoUid").textContent = user.uid;

    $("btnLogout").classList.remove("hide");
    $("btnGoogle").classList.add("hide");
    $("btnApple").classList.add("hide");

    // GİRİŞ VARSA FORM GÖRÜNÜR
    $("formCard").classList.remove("hide");
    $("warn").textContent = "Giriş OK. Formu doldurabilirsin.";
  }

  async function loginWith(provider, label){
    debug(`LOGIN: ${label} start`);
    try {
      await signInWithPopup(auth, provider);
      debug(`LOGIN: ${label} popup OK`);
    } catch(e){
      debug(`LOGIN: ${label} popup FAIL -> redirect. ` + (e?.code || e));
      await signInWithRedirect(auth, provider);
    }
  }

  async function doLogout(){
    try{
      await signOut(auth);
      debug("LOGOUT: OK");
      renderSignedOut();
    }catch(e){
      debug("LOGOUT ERROR: " + (e?.code || e));
    }
  }

  // Kamera / galeri butonları
  function wirePicker(btnId, inputId){
    $(btnId).addEventListener("click", () => $(inputId).click());
  }
  wirePicker("pick1","file1");
  wirePicker("take1","cam1");
  wirePicker("pick2","file2");
  wirePicker("take2","cam2");

  function setPreview(file, prevId){
    const box = $(prevId);
    if(!file){ box.textContent = prevId==="prev1" ? "Önizleme 1" : "Önizleme 2"; return; }
    const url = URL.createObjectURL(file);
    box.innerHTML = `<img src="${url}" alt="preview">`;
  }

  $("file1").addEventListener("change", (e)=>setPreview(e.target.files?.[0], "prev1"));
  $("cam1").addEventListener("change", (e)=>setPreview(e.target.files?.[0], "prev1"));
  $("file2").addEventListener("change", (e)=>setPreview(e.target.files?.[0], "prev2"));
  $("cam2").addEventListener("change", (e)=>setPreview(e.target.files?.[0], "prev2"));

  // Submit placeholder (senin upload/firestore koduna bağlanacak)
  $("btnSend").addEventListener("click", ()=>{
    alert("Gönderme kodunu senin mevcut upload akışına bağlayacağız.");
  });

  // BOOT
  $("debug").textContent = "";
  debug("BOOT: auth ready");
  await ensurePersistence();

  try{
    debug("REDIRECT: getRedirectResult()");
    const res = await getRedirectResult(auth);
    debug("REDIRECT: " + (res?.user ? "user OK" : "empty (normal olabilir)"));
  }catch(e){
    debug("REDIRECT ERROR: " + (e?.code || e));
  }

  onAuthStateChanged(auth, (user)=>{
    if(!user){
      debug("AUTH STATE: signed out");
      renderSignedOut();
    } else {
      debug("AUTH STATE: signed in");
      renderSignedIn(user);
    }
  });

  $("btnGoogle").addEventListener("click", ()=>loginWith(googleProvider,"google"));
  $("btnApple").addEventListener("click", ()=>loginWith(appleProvider,"apple"));
  $("btnLogout").addEventListener("click", doLogout);

  renderSignedOut();
</script>
</body>
</html>