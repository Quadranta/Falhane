<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Falhane Kullanıcı Paneli</title>
  <style>
    :root { --bg:#f4f7fb; --card:#fff; --text:#0f172a; --muted:#64748b; --blue:#2563eb; --green:#16a34a; --red:#ef4444; --dark:#0b1220; --line:#e5e7eb; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }
    .wrap{ max-width:760px; margin:0 auto; padding:18px 14px 40px; }
    h1{ margin:6px 0 14px; font-size:40px; letter-spacing:-.5px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:18px; padding:16px; box-shadow:0 8px 25px rgba(2,6,23,.05); margin-bottom:14px; }
    .banner{ background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; padding:10px 12px; border-radius:14px; margin-bottom:14px; font-weight:700; }
    .ok{ background:#ecfdf5; border-color:#bbf7d0; color:#166534; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{ border:0; border-radius:12px; padding:11px 14px; font-weight:800; cursor:pointer; }
    .btn.blue{ background:var(--blue); color:#fff; }
    .btn.dark{ background:var(--dark); color:#fff; }
    .btn.green{ background:var(--green); color:#fff; }
    .btn.ghost{ background:#eef2ff; color:#1e3a8a; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .meta{ color:var(--muted); font-size:14px; line-height:1.35; margin-top:8px; }
    label{ display:block; font-weight:800; margin:10px 0 6px; }
    input, select{ width:100%; padding:12px 12px; border:1px solid var(--line); border-radius:12px; font-size:16px; background:#fff; }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .small{ font-size:13px; color:var(--muted); }
    .previews{ display:flex; gap:10px; margin-top:10px; }
    .ph{ width:92px; height:120px; border:1px dashed #cbd5e1; border-radius:14px; background:#fff; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .ph img{ width:100%; height:100%; object-fit:cover; display:block; }
    .debug{ background:#0b1220; color:#e2e8f0; border-radius:14px; padding:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; white-space:pre-wrap; }
    .hr{ height:1px; background:var(--line); margin:14px 0; }
    .hide{ display:none !important; }
    .pill{ display:inline-block; padding:4px 10px; border-radius:999px; font-weight:900; font-size:12px; background:#eef2ff; color:#1e3a8a; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Falhane Kullanıcı Paneli</h1>

    <div id="banner" class="banner">Oturum kapalı. Google ile giriş yap.</div>

    <div class="card">
      <h2 style="margin:0 0 10px;">Giriş (Google)</h2>
      <div class="row">
        <button id="btnGoogleLogin" class="btn blue" type="button">Google ile giriş</button>
        <button id="btnLogout" class="btn dark" type="button">Çıkış</button>
      </div>

      <div class="meta">
        Giriş yapan: <b id="lblEmail">-</b><br>
        UID: <b id="lblUid">-</b><br>
        <span class="small">Not: Bu sayfa upload oluşturur. Admin paneli “uploads” içinden onaylayınca “readings”e taşır.</span>
      </div>
    </div>

    <div class="card" id="formCard">
      <h2 style="margin:0 0 8px;">Fal Başvurusu (2 Foto)</h2>
      <div class="small">Bu formu göndermek için giriş yapman gerekiyor.</div>
      <div class="hr"></div>

      <label for="inpName">Ad</label>
      <input id="inpName" placeholder="Adın" autocomplete="name" />

      <label for="inpAge">Yaş</label>
      <input id="inpAge" placeholder="Örn: 26" inputmode="numeric" />

      <label for="selSign">Burç</label>
      <select id="selSign">
        <option value="">Seç</option>
        <option value="Koç">Koç</option>
        <option value="Boğa">Boğa</option>
        <option value="İkizler">İkizler</option>
        <option value="Yengeç">Yengeç</option>
        <option value="Aslan">Aslan</option>
        <option value="Başak">Başak</option>
        <option value="Terazi">Terazi</option>
        <option value="Akrep">Akrep</option>
        <option value="Yay">Yay</option>
        <option value="Oğlak">Oğlak</option>
        <option value="Kova">Kova</option>
        <option value="Balık">Balık</option>
      </select>

      <div class="hr"></div>

      <label>Foto 1 <span class="pill">Galeri</span></label>
      <input id="file1" type="file" accept="image/*" />

      <div style="margin-top:8px;">
        <button id="cam1" type="button" class="btn ghost">Kamera ile çek</button>
        <input id="camFile1" class="hide" type="file" accept="image/*" capture="environment" />
      </div>

      <label style="margin-top:14px;">Foto 2 <span class="pill">Galeri</span></label>
      <input id="file2" type="file" accept="image/*" />

      <div style="margin-top:8px;">
        <button id="cam2" type="button" class="btn ghost">Kamera ile çek</button>
        <input id="camFile2" class="hide" type="file" accept="image/*" capture="environment" />
      </div>

      <div class="previews">
        <div class="ph" title="Foto 1 önizleme"><img id="prev1" alt="" /></div>
        <div class="ph" title="Foto 2 önizleme"><img id="prev2" alt="" /></div>
      </div>

      <div class="hr"></div>
      <button id="btnSubmit" class="btn green" type="button">Başvuruyu Gönder</button>

      <div class="meta" id="submitStatus"></div>
      <div class="small" style="margin-top:6px;">
        İpucu: “Kamera ile çek” butonu telefonda kamerayı açar. Normal seçim alanı galeriden seçmek içindir.
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px;">Debug</h2>
      <div id="debugBox" class="debug">Hazır.</div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider,
      signInWithRedirect, getRedirectResult,
      onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    // ✅ Senin config’in
    const firebaseConfig = {
      apiKey: "AIzaSyBDTN_8sf9P7uwtnRqBTmlszcztb36g-XA",
      authDomain: "falhane-e3057.firebaseapp.com",
      projectId: "falhane-e3057",
      storageBucket: "falhane-e3057.firebasestorage.app",
      messagingSenderId: "117754512778",
      appId: "1:117754512778:web:52aee440472568bc6cb473",
      measurementId: "G-94TZ14VWPX"
    };

    // ---- init ----
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: "select_account" });

    // ---- UI ----
    const banner = document.getElementById("banner");
    const debugBox = document.getElementById("debugBox");
    const log = (m) => { debugBox.textContent += "\n" + m; };

    const btnGoogleLogin = document.getElementById("btnGoogleLogin");
    const btnLogout = document.getElementById("btnLogout");
    const lblEmail = document.getElementById("lblEmail");
    const lblUid = document.getElementById("lblUid");

    const formCard = document.getElementById("formCard");
    const inpName = document.getElementById("inpName");
    const inpAge = document.getElementById("inpAge");
    const selSign = document.getElementById("selSign");

    const file1 = document.getElementById("file1");
    const file2 = document.getElementById("file2");
    const cam1Btn = document.getElementById("cam1");
    const cam2Btn = document.getElementById("cam2");
    const camFile1 = document.getElementById("camFile1");
    const camFile2 = document.getElementById("camFile2");

    const prev1 = document.getElementById("prev1");
    const prev2 = document.getElementById("prev2");

    const btnSubmit = document.getElementById("btnSubmit");
    const submitStatus = document.getElementById("submitStatus");

    let currentUser = null;
    let selected1 = null;
    let selected2 = null;

    const setSignedOutUI = () => {
      banner.classList.remove("ok");
      banner.textContent = "Oturum kapalı. Google ile giriş yap.";
      lblEmail.textContent = "-";
      lblUid.textContent = "-";
      formCard.style.opacity = "0.55";
      formCard.style.pointerEvents = "none";
      btnLogout.disabled = true;
    };

    const setSignedInUI = (user) => {
      banner.classList.add("ok");
      banner.textContent = "Oturum açık.";
      lblEmail.textContent = user.email || "-";
      lblUid.textContent = user.uid || "-";
      formCard.style.opacity = "1";
      formCard.style.pointerEvents = "auto";
      btnLogout.disabled = false;
    };

    // ---- helpers ----
    function fileToPreview(file, imgEl) {
      if (!file) { imgEl.removeAttribute("src"); return; }
      const url = URL.createObjectURL(file);
      imgEl.src = url;
    }

    function nowId() {
      return Date.now().toString();
    }

    async function uploadOne(uid, docId, file, index) {
      const ext = (file.name && file.name.includes(".")) ? file.name.split(".").pop() : "jpg";
      const path = `uploads/${uid}/${docId}/photo${index}.${ext}`;
      const r = ref(storage, path);
      await uploadBytes(r, file);
      return await getDownloadURL(r);
    }

    function requireSignedIn() {
      if (!currentUser) throw new Error("signed_out");
    }

    // ---- Auth redirect result ----
    log("BOOT: auth ready");
    getRedirectResult(auth)
      .then((result) => {
        if (result && result.user) log("REDIRECT RESULT: OK");
        else log("REDIRECT RESULT: boş (normal olabilir)");
      })
      .catch((err) => {
        log("REDIRECT ERROR: " + (err?.code || err?.message || err));
      });

    onAuthStateChanged(auth, (user) => {
      currentUser = user || null;
      if (user) {
        log("AUTH STATE: signed in");
        setSignedInUI(user);
      } else {
        log("AUTH STATE: signed out");
        setSignedOutUI();
      }
    });

    // ---- Login/Logout ----
    btnGoogleLogin.addEventListener("click", async () => {
      try {
        log("LOGIN: redirect başlatılıyor...");
        await signInWithRedirect(auth, provider);
      } catch (err) {
        log("LOGIN ERROR: " + (err?.code || err?.message || err));
        alert("Giriş hatası: " + (err?.code || err?.message || err));
      }
    });

    btnLogout.addEventListener("click", async () => {
      try {
        await signOut(auth);
        log("LOGOUT: OK");
      } catch (err) {
        log("LOGOUT ERROR: " + (err?.code || err?.message || err));
      }
    });

    // ---- File selection (Gallery) ----
    file1.addEventListener("change", (e) => {
      selected1 = e.target.files?.[0] || null;
      fileToPreview(selected1, prev1);
    });
    file2.addEventListener("change", (e) => {
      selected2 = e.target.files?.[0] || null;
      fileToPreview(selected2, prev2);
    });

    // ---- Camera buttons ----
    cam1Btn.addEventListener("click", () => camFile1.click());
    cam2Btn.addEventListener("click", () => camFile2.click());

    camFile1.addEventListener("change", (e) => {
      selected1 = e.target.files?.[0] || null;
      fileToPreview(selected1, prev1);
      // galeri inputunu temizle (karışmasın)
      file1.value = "";
    });

    camFile2.addEventListener("change", (e) => {
      selected2 = e.target.files?.[0] || null;
      fileToPreview(selected2, prev2);
      file2.value = "";
    });

    // ---- Submit ----
    btnSubmit.addEventListener("click", async () => {
      submitStatus.textContent = "";
      btnSubmit.disabled = true;

      try {
        requireSignedIn();

        const name = (inpName.value || "").trim();
        const age = (inpAge.value || "").trim();
        const sign = (selSign.value || "").trim();

        if (!name) throw new Error("Lütfen ad gir.");
        if (!age || isNaN(Number(age))) throw new Error("Yaş sayı olmalı.");
        if (!sign) throw new Error("Lütfen burç seç.");
        if (!selected1 || !selected2) throw new Error("2 foto seçmelisin.");

        const uid = currentUser.uid;
        const docId = `u_${nowId()}_${Math.random().toString(36).slice(2,8)}`;

        submitStatus.textContent = "Yükleniyor...";

        const url1 = await uploadOne(uid, docId, selected1, 1);
        const url2 = await uploadOne(uid, docId, selected2, 2);

        await addDoc(collection(db, "uploads"), {
          status: "pending",
          name,
          age: Number(age),
          sign,
          userId: uid,
          photo1Url: url1,
          photo2Url: url2,
          createdAt: serverTimestamp()
        });

        submitStatus.textContent = "Başvuru gönderildi (pending). Admin onaylayınca reading oluşacak.";
        submitStatus.style.color = "#166534";

        // temizle
        inpName.value = "";
        inpAge.value = "";
        selSign.value = "";
        file1.value = "";
        file2.value = "";
        camFile1.value = "";
        camFile2.value = "";
        selected1 = null;
        selected2 = null;
        prev1.removeAttribute("src");
        prev2.removeAttribute("src");

        log("UPLOAD: OK");
      } catch (err) {
        const msg = (err?.message || err?.code || err || "").toString();
        submitStatus.textContent = "Hata: " + msg;
        submitStatus.style.color = "#b91c1c";
        log("SUBMIT ERROR: " + (err?.code || err?.message || err));

        if (err?.code === "storage/unauthorized" || err?.code === "permission-denied") {
          alert("Yetki hatası: Storage/Firestore rules kontrol et. (userId bazlı yazma izni lazım)");
        } else {
          alert("Hata: " + msg);
        }
      } finally {
        btnSubmit.disabled = false;
      }
    });

    // initial
    setSignedOutUI();
  </script>
</body>
</html>