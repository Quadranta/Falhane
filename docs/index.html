<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Falhane Kullanıcı Paneli</title>
  <style>
    :root { --bg:#f3f5f9; --card:#fff; --text:#0f172a; --muted:#64748b; --blue:#2563eb; --dark:#0b1220; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --border:#e5e7eb; }
    body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial; background:var(--bg); color:var(--text); }
    .wrap{ max-width: 920px; margin: 22px auto; padding: 0 14px; }
    h1{ font-size: clamp(34px, 6vw, 56px); margin: 14px 0 18px; letter-spacing:-0.02em; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:18px; padding:16px; box-shadow: 0 10px 28px rgba(2,8,23,.06); margin-bottom:14px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{ border:0; border-radius:12px; padding:12px 14px; cursor:pointer; font-weight:800; }
    .btn.blue{ background:var(--blue); color:#fff; }
    .btn.dark{ background:var(--dark); color:#fff; }
    .btn.gray{ background:#e2e8f0; color:#111827; }
    .btn.green{ background:var(--ok); color:#fff; }
    .pill{ display:inline-block; padding:8px 10px; border-radius:999px; background:#eef2ff; color:#1e3a8a; font-weight:800; }
    .muted{ color:var(--muted); }
    .status{ border-radius:14px; padding:12px 14px; font-weight:900; }
    .status.ok{ background:#dcfce7; color:#065f46; border:1px solid #bbf7d0; }
    .status.warn{ background:#fef3c7; color:#7c2d12; border:1px solid #fde68a; }
    .status.bad{ background:#fee2e2; color:#7f1d1d; border:1px solid #fecaca; }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width:720px){ .grid{ grid-template-columns:1fr; } }
    label{ display:block; font-weight:900; margin:10px 0 6px; }
    input, select{ width:100%; box-sizing:border-box; padding:12px 12px; border-radius:12px; border:1px solid var(--border); background:#fff; font-size:16px; }
    .small{ font-size:13px; }
    .divider{ height:1px; background:var(--border); margin:12px 0; }
    .kvs{ display:flex; gap:10px; flex-wrap:wrap; }
    .kvs .k{ font-weight:900; }
    pre{ margin:0; white-space:pre-wrap; word-break:break-word; background:#0b1220; color:#e2e8f0; padding:14px; border-radius:14px; overflow:auto; }
    .hide{ display:none !important; }
    .thumbs{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .thumb{ width:86px; height:86px; border-radius:14px; border:1px solid var(--border); background:#fff; object-fit:cover; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Falhane Kullanıcı Paneli</h1>

    <div id="topStatus" class="status warn">Oturum kapalı. Google ile giriş yap.</div>

    <div class="card">
      <h2 style="margin:0 0 10px;">Giriş (Google)</h2>
      <div class="row">
        <button id="btnGoogle" class="btn blue">Google ile giriş</button>
        <button id="btnLogout" class="btn dark hide">Çıkış</button>
      </div>
      <div class="divider"></div>
      <div class="kvs">
        <div><span class="k">Giriş yapan:</span> <span id="userEmail">-</span></div>
        <div><span class="k">UID:</span> <span id="userUid">-</span></div>
      </div>
      <p class="muted small" style="margin-top:10px;">
        Not: Bu sayfa upload oluşturur. Admin paneli “uploads” içinden onaylayınca “readings”e taşır.
      </p>
    </div>

    <div class="card" id="formCard">
      <h2 style="margin:0 0 10px;">Fal Başvurusu (2 Foto)</h2>

      <div class="grid">
        <div>
          <label>Ad</label>
          <input id="inpName" placeholder="Adın" autocomplete="name" />
        </div>
        <div>
          <label>Yaş</label>
          <input id="inpAge" type="number" min="1" max="120" placeholder="Örn: 26" />
        </div>
      </div>

      <label>Burç</label>
      <select id="inpSign">
        <option value="">Seç</option>
        <option>Koç</option><option>Boğa</option><option>İkizler</option><option>Yengeç</option>
        <option>Aslan</option><option>Başak</option><option>Terazi</option><option>Akrep</option>
        <option>Yay</option><option>Oğlak</option><option>Kova</option><option>Balık</option>
      </select>

      <div class="divider"></div>

      <!-- Foto 1 -->
      <label>Foto 1</label>
      <div class="row">
        <input id="file1Pick" type="file" accept="image/*" />
        <input id="file1Cam" type="file" accept="image/*" capture="environment" class="hide" />
        <button id="btnCam1" class="btn gray" type="button">Kamera ile çek</button>
      </div>

      <!-- Foto 2 -->
      <label>Foto 2</label>
      <div class="row">
        <input id="file2Pick" type="file" accept="image/*" />
        <input id="file2Cam" type="file" accept="image/*" capture="environment" class="hide" />
        <button id="btnCam2" class="btn gray" type="button">Kamera ile çek</button>
      </div>

      <div class="thumbs">
        <img id="thumb1" class="thumb" alt="Foto1 önizleme" />
        <img id="thumb2" class="thumb" alt="Foto2 önizleme" />
      </div>

      <div class="divider"></div>

      <div class="row">
        <button id="btnSend" class="btn green" type="button">Başvuruyu Gönder</button>
      </div>

      <p class="muted small" style="margin-top:10px;">
        İpucu: “Kamera ile çek” butonu telefonda kamerayı açar. Normal seçme alanı galeriden seçmek içindir.
      </p>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px;">Debug</h2>
      <pre id="debug">Hazır.</pre>
    </div>

  </div>

  <!-- Firebase SDK (modüler) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithRedirect, getRedirectResult, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    // ==== SENİN CONFIG ====
    const firebaseConfig = {
      apiKey: "AIzaSyBDTN_8sf9P7uwtnRqBTmlszcztb36g-XA",
      authDomain: "falhane-e3057.firebaseapp.com",
      projectId: "falhane-e3057",
      storageBucket: "falhane-e3057.firebasestorage.app",
      messagingSenderId: "117754512778",
      appId: "1:117754512778:web:52aee440472568bc6cb473",
      measurementId: "G-94TZ14VWPX"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const $ = (id) => document.getElementById(id);
    const log = (m) => { $("debug").textContent += "\n" + m; };

    // UI refs
    const topStatus = $("topStatus");
    const btnGoogle = $("btnGoogle");
    const btnLogout = $("btnLogout");
    const userEmail = $("userEmail");
    const userUid = $("userUid");
    const formCard = $("formCard");

    const inpName = $("inpName");
    const inpAge = $("inpAge");
    const inpSign = $("inpSign");

    // File inputs (picker + camera)
    const file1Pick = $("file1Pick");
    const file2Pick = $("file2Pick");
    const file1Cam  = $("file1Cam");
    const file2Cam  = $("file2Cam");
    const btnCam1   = $("btnCam1");
    const btnCam2   = $("btnCam2");
    const thumb1    = $("thumb1");
    const thumb2    = $("thumb2");

    const btnSend = $("btnSend");

    let currentUser = null;
    let f1 = null, f2 = null; // gerçek dosyalar

    function setStatus(type, text){
      topStatus.className = "status " + type;
      topStatus.textContent = text;
    }

    function preview(file, imgEl){
      if(!file){ imgEl.removeAttribute("src"); return; }
      const url = URL.createObjectURL(file);
      imgEl.src = url;
    }

    // Kamera butonları: gizli capture input'u tetikler
    btnCam1.addEventListener("click", () => file1Cam.click());
    btnCam2.addEventListener("click", () => file2Cam.click());

    // Picker seçimi
    file1Pick.addEventListener("change", (e) => {
      f1 = e.target.files?.[0] || null;
      preview(f1, thumb1);
    });
    file2Pick.addEventListener("change", (e) => {
      f2 = e.target.files?.[0] || null;
      preview(f2, thumb2);
    });

    // Kamera çekimi
    file1Cam.addEventListener("change", (e) => {
      f1 = e.target.files?.[0] || null;
      preview(f1, thumb1);
    });
    file2Cam.addEventListener("change", (e) => {
      f2 = e.target.files?.[0] || null;
      preview(f2, thumb2);
    });

    btnGoogle.addEventListener("click", async () => {
      $("debug").textContent = "BOOT:\nurl=" + location.href + "\n";
      const provider = new GoogleAuthProvider();
      await signInWithRedirect(auth, provider);
    });

    btnLogout.addEventListener("click", async () => {
      await signOut(auth);
      setStatus("warn", "Oturum kapalı. Google ile giriş yap.");
    });

    // Redirect sonucu
    (async () => {
      try {
        log("REDIRECT: getRedirectResult() çağrılıyor...");
        const res = await getRedirectResult(auth);
        if(res?.user){
          log("REDIRECT: kullanıcı geldi: " + (res.user.email || res.user.uid));
        } else {
          log("REDIRECT: sonuç yok (normal).");
        }
      } catch (e) {
        log("REDIRECT ERROR: " + (e?.code || e?.message || e));
      }
    })();

    // Auth state
    onAuthStateChanged(auth, (u) => {
      currentUser = u || null;
      if(!currentUser){
        userEmail.textContent = "-";
        userUid.textContent = "-";
        btnLogout.classList.add("hide");
        setStatus("warn", "Oturum kapalı. Google ile giriş yap.");
        return;
      }
      userEmail.textContent = currentUser.email || "(email yok)";
      userUid.textContent = currentUser.uid;
      btnLogout.classList.remove("hide");
      setStatus("ok", "Giriş başarılı.");
      log("AUTH STATE: signed in");
    });

    async function uploadToStorage(file, path){
      const r = ref(storage, path);
      await uploadBytes(r, file);
      return await getDownloadURL(r);
    }

    btnSend.addEventListener("click", async () => {
      try {
        if(!currentUser){
          setStatus("bad", "Önce Google ile giriş yap.");
          return;
        }
        const name = (inpName.value || "").trim();
        const age = parseInt(inpAge.value, 10);
        const sign = (inpSign.value || "").trim();

        if(!name){ setStatus("bad", "Ad boş olamaz."); return; }
        if(!age || age < 1 || age > 120){ setStatus("bad", "Yaş hatalı."); return; }
        if(!sign){ setStatus("bad", "Burç seç."); return; }
        if(!f1 || !f2){ setStatus("bad", "2 foto seç / çek."); return; }

        setStatus("warn", "Yükleniyor...");

        const docId = `u_${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
        const basePath = `uploads/${currentUser.uid}/${docId}`;

        const url1 = await uploadToStorage(f1, `${basePath}/photo1.jpg`);
        const url2 = await uploadToStorage(f2, `${basePath}/photo2.jpg`);

        // Burç alanını iki isimle yazıyoruz: sign + burc (admin hangisini okuyorsa)
        const payload = {
          status: "pending",
          createdAt: serverTimestamp(),
          userId: currentUser.uid,
          name,
          age,
          sign,      // <-- admin bunu okuyorsa
          burc: sign // <-- admin burc alanını okuyorsa
        };

        // URL'leri de sakla
        payload.photo1 = url1;
        payload.photo2 = url2;

        await addDoc(collection(db, "uploads"), payload);

        setStatus("ok", "Başvuru gönderildi (pending). Admin onaylayınca reading oluşacak.");
        log("UPLOAD OK: " + docId);

        // Formu temizle
        f1 = null; f2 = null;
        file1Pick.value = ""; file2Pick.value = "";
        file1Cam.value = "";  file2Cam.value = "";
        preview(null, thumb1); preview(null, thumb2);

      } catch (e) {
        setStatus("bad", "Hata: " + (e?.code || e?.message || e));
        log("SEND ERROR: " + (e?.code || e?.message || e));
      }
    });
  </script>
</body>
</html>